<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LifeStats</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- Theme Color -->
    <meta name="theme-color" content="#60a5fa">

    <!-- Apple iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LifeStats">
    <link rel="apple-touch-icon" href="/icon-512.png">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/icon-512.png">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #18181b 0%, #27272a 100%);
            color: #e4e4e7;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 120px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        h1 {
            color: #a1a1aa;
            font-size: 2em;
            margin-bottom: 10px;
            text-align: center;
        }

        .user-id {
            text-align: center;
            font-size: 0.75em;
            color: #71717a;
            margin-bottom: 30px;
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dotted;
        }

        /* Page 1 (Stats) specific override for wider layout */
        #page1 .container {
            max-width: 1200px;
        }

        /* Card Styles */
        .card {
            background: rgba(39, 39, 42, 0.6);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: none;
            position: relative;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #a1a1aa;
            font-size: 0.9em;
            font-weight: 500;
        }

        input[type="text"],
        input[type="search"],
        input[type="number"],
        select {
            width: 100%;
            padding: 12px 16px;
            background: rgba(24, 24, 27, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            color: #e4e4e7;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #71717a;
            box-shadow: 0 0 0 2px rgba(113, 113, 122, 0.2);
        }

        /* Search Results Dropdown */
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #27272a;
            border: 1px solid #3f3f46;
            border-radius: 12px;
            margin-top: 4px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 50;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            display: none;
        }

        .search-result-item {
            padding: 12px 16px;
            border-bottom: 1px solid #3f3f46;
            cursor: pointer;
            transition: background 0.2s;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background: #3f3f46;
        }

        .search-result-name {
            font-weight: 600;
            color: #e4e4e7;
        }

        .search-result-details {
            font-size: 0.85em;
            color: #a1a1aa;
            margin-top: 2px;
        }

        /* Nutrition Grid */
        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .nutrition-item label {
            font-size: 0.75em;
            margin-bottom: 4px;
            color: #a1a1aa;
        }

        .nutrition-item input {
            padding: 8px;
            font-size: 0.9em;
            text-align: center;
        }

        .toggle-btn {
            background: none;
            border: none;
            color: #a1a1aa;
            font-size: 0.85em;
            cursor: pointer;
            padding: 0;
            margin-top: 8px;
            text-decoration: underline;
            box-shadow: none;
        }

        .toggle-btn:hover {
            transform: none;
            box-shadow: none;
            color: #d4d4d8;
        }

        button.primary-btn {
            width: 100%;
            padding: 14px;
            background: #2ECC71;
            color: #ffffff;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: none;
        }

        button.primary-btn:hover {
            transform: scale(1.02);
            background: #27ae60;
        }

        button.primary-btn:active {
            transform: scale(0.98);
        }

        /* Meals List */
        .section-title {
            font-size: 1.3em;
            margin-bottom: 16px;
            color: #a1a1aa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .daily-total {
            font-size: 0.8em;
            color: #71717a;
            font-weight: normal;
        }

        .meals-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .meal-item {
            background: rgba(39, 39, 42, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
        }

        .meal-item:hover {
            border-color: rgba(255, 255, 255, 0.1);
            transform: translateX(4px);
        }

        .meal-emoji {
            font-size: 1.8em;
            flex-shrink: 0;
        }

        .meal-info {
            flex: 1;
        }

        .meal-name {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .meal-time {
            font-size: 0.85em;
            color: #71717a;
        }

        .meal-macros {
            font-size: 0.85em;
            color: #a1a1aa;
            margin-top: 2px;
        }

        .meal-delete {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #fca5a5;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .meal-delete:hover {
            background: rgba(239, 68, 68, 0.3);
            border-color: rgba(239, 68, 68, 0.5);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }

        .empty-state-emoji {
            font-size: 3em;
            margin-bottom: 12px;
        }

        /* Success Animation */
        @keyframes successPulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(34, 197, 94, 0);
            }

            100% {
                transform: scale(1);
            }
        }

        .success-feedback {
            animation: successPulse 0.5s ease;
        }

        .hidden {
            display: none !important;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            -webkit-backdrop-filter: blur(4px);
            backdrop-filter: blur(4px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.4s ease;
            /* Smooth fade in of blur/bg */
            padding: 20px;
        }

        .modal {
            background: #27272a;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            animation: modalSlideUp 0.3s ease;
            scrollbar-width: thin;
            scrollbar-color: #3f3f46 transparent;
        }

        .modal::-webkit-scrollbar {
            width: 6px;
        }

        .modal::-webkit-scrollbar-track {
            background: transparent;
        }

        .modal::-webkit-scrollbar-thumb {
            background: #3f3f46;
            border-radius: 10px;
        }

        @keyframes modalSlideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #e4e4e7;
        }

        .close-btn {
            background: none;
            border: none;
            color: #a1a1aa;
            font-size: 1.5em;
            cursor: pointer;
            padding: 4px;
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn-secondary {
            background: rgba(113, 113, 122, 0.2);
            color: #a1a1aa;
            border: 1px solid rgba(113, 113, 122, 0.2);
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            flex: 1;
            font-weight: 500;
        }

        .meal-type-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .meal-type-btn {
            background: rgba(39, 39, 42, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px 4px;
            color: #a1a1aa;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .meal-type-btn:hover {
            border-color: rgba(255, 255, 255, 0.2);
            background: rgba(39, 39, 42, 0.8);
        }

        .meal-type-btn.active {
            box-shadow: none;
        }

        /* Meal Type Specific Tints */
        .meal-type-btn[data-value="breakfast"].active {
            background: rgba(250, 204, 21, 0.15);
            /* Soft Yellow */
            border-color: rgba(250, 204, 21, 0.4);
            color: #facc15;
        }

        .meal-type-btn[data-value="lunch"].active {
            background: rgba(46, 204, 113, 0.15);
            /* Leaf Green */
            border-color: rgba(46, 204, 113, 0.4);
            color: #2ecc71;
        }

        .meal-type-btn[data-value="dinner"].active {
            background: rgba(59, 130, 246, 0.15);
            /* Soft Blue */
            border-color: rgba(59, 130, 246, 0.4);
            color: #60a5fa;
        }

        .meal-type-btn[data-value="snack"].active {
            background: rgba(244, 114, 182, 0.15);
            /* Soft Pink/Red */
            border-color: rgba(244, 114, 182, 0.4);
            color: #f472b6;
        }

        .meal-type-btn .emoji {
            font-size: 1.5em;
        }

        .meal-type-btn .emoji {
            font-size: 1.5em;
        }

        /* Expansion Overlay */
        #expansion-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 44px;
            height: 44px;
            background: #2ECC71;
            border-radius: 10px;
            /* Match button radius start */
            z-index: 99;
            opacity: 0;
            pointer-events: none;
        }

        .notification-toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(34, 197, 94, 0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            font-weight: 500;
            z-index: 1000;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            gap: 8px;
            -webkit-backdrop-filter: blur(4px);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .notification-toast.show {
            transform: translateX(-50%) translateY(0);
        }

        /* Custom Food Modal Redesign */
        .custom-food-modal .modal {
            max-width: 500px;
            background: #18181b;
            border: 6px solid #2ECC71;
            /* Thick Green Outline */
            box-shadow: none;
            animation: none;
            /* Disable default bounce */
        }

        .custom-food-modal .close-btn {
            color: #ef4444;
            font-size: 2.2em;
            transition: transform 0.2s;
        }

        .custom-food-modal .close-btn:hover {
            transform: scale(1.1);
            color: #ff0000;
        }

        .custom-food-header-input {
            background: transparent;
            border: none;
            border-bottom: 2px solid #27272a;
            border-radius: 0;
            font-size: 1.2em;
            padding: 8px 0;
            color: #e4e4e7;
        }

        .custom-food-header-input:focus {
            box-shadow: none;
            border-color: #71717a;
        }

        .macro-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            background: rgba(39, 39, 42, 0.4);
            padding: 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .macro-row label {
            margin-bottom: 0;
            flex: 1;
            font-size: 1.1em;
            color: #a1a1aa;
        }

        .macro-input-group {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 8px;
        }

        .macro-input-group input {
            width: 80px;
            text-align: right;
            font-size: 1.2rem;
            padding: 8px;
            background: rgba(39, 39, 42, 0.6);
            border: 1px solid #3f3f46;
        }

        .calories-hero {
            text-align: center;
            margin-bottom: 24px;
            background: rgba(255, 85, 51, 0.15);
            /* #ff5533 */
            padding: 20px;
            border-radius: 16px;
            border: 1px solid rgba(255, 85, 51, 0.2);
        }

        .calories-hero label {
            color: #ff5533;
            font-size: 0.9em;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .calories-hero input {
            font-size: 3em;
            width: 100%;
            text-align: center;
            border: none;
            background: transparent;
            color: #ff5533;
            padding: 0;
            font-weight: 700;
        }

        .calories-hero input:focus {
            box-shadow: none;
        }

        .expand-section {
            border-top: 1px solid #27272a;
            margin-top: 16px;
            padding-top: 16px;
        }

        .expand-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: #71717a;
            font-size: 0.9em;
            cursor: pointer;
            padding: 8px 0;
            user-select: none;
        }

        .expand-header:hover {
            color: #a1a1aa;
        }

        .expand-content {
            display: none;
            padding-top: 12px;
            animation: slideDown 0.2s ease;
        }

        .expand-content.open {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .mini-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .mini-input-group {
            text-align: center;
        }

        .mini-input-group label {
            font-size: 0.75em;
            color: #71717a;
            margin-bottom: 4px;
        }

        .mini-input-group input {
            padding: 8px 4px;
            text-align: center;
            font-size: 1em;
        }

        /* Chips */
        .chip-container {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 4px 0;
            margin-top: 8px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .chip-container::-webkit-scrollbar {
            display: none;
        }

        .chip {
            background: rgba(39, 39, 42, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #a1a1aa;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .chip:hover {
            background: rgba(39, 39, 42, 0.8);
            border-color: #71717a;
            color: #e4e4e7;
        }

        .chip:active {
            transform: scale(0.95);
        }

        /* Goals Tab Chips */
        .goals-range-selector {
            display: flex;
            background: rgba(39, 39, 42, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 4px;
            gap: 4px;
        }

        .goals-range-option {
            flex: 1;
            padding: 8px;
            text-align: center;
            color: #a1a1aa;
            font-size: 0.9em;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .goals-range-option:hover {
            color: #e4e4e7;
            background: rgba(255, 255, 255, 0.05);
        }

        .goals-range-option.active {
            background: #27272a;
            color: #e4e4e7;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            font-weight: 600;
        }

        .goals-metric-chip.selected {
            font-weight: 500;
        }

        /* Page Container Styles */
        .page-content {
            display: none;
        }

        .page-content.active {
            display: block;
        }

        /* Bottom Tab Bar */
        .bottom-tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            min-height: 70px;
            background: rgba(39, 39, 42, 0.95);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px 8px;
            padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 20px);
            z-index: 90;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
        }

        .tab-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #71717a;
            text-decoration: none;
            user-select: none;
        }

        .tab-item:hover {
            color: #a1a1aa;
        }

        .tab-item.active {
            color: #2ECC71;
        }

        .tab-item.active .tab-icon {
            transform: scale(1.1);
        }

        .tab-icon {
            font-size: 24px;
            transition: transform 0.2s ease;
        }

        .tab-label {
            font-size: 11px;
            font-weight: 500;
            letter-spacing: 0.3px;
        }

        /* Center tab special styling */
        .tab-item:nth-child(3) .tab-icon {
            font-size: 28px;
        }

        .tab-item:nth-child(3).active .tab-icon {
            transform: scale(1.15);
        }

        /* Event Types Styles */
        .event-types-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .event-type-row {
            background: rgba(39, 39, 42, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .event-type-row:hover {
            background: rgba(39, 39, 42, 0.6);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .event-type-icon {
            font-size: 32px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            flex-shrink: 0;
        }

        .event-type-info {
            flex: 1;
            min-width: 0;
        }

        .event-type-name {
            font-size: 1.1em;
            font-weight: 600;
            color: #e4e4e7;
            margin-bottom: 4px;
        }

        .event-type-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .event-type-category {
            font-size: 0.75em;
            padding: 2px 8px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: #a1a1aa;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .event-type-unit {
            font-size: 0.85em;
            color: #71717a;
        }

        .category-chip.active {
            background: rgba(46, 204, 113, 0.2);
            border-color: #2ECC71;
            color: #2ECC71;
        }

        /* Rating Stars */
        .rating-star-btn {
            font-size: 32px;
            color: #555;
            cursor: pointer;
            transition: transform 0.1s ease, color 0.2s ease;
            user-select: none;
            padding: 0 2px;
        }

        .rating-star-btn:active {
            transform: scale(0.9);
        }

        .rating-star-btn.active {
            color: #FFD700;
            /* Gold */
        }

        .check-btn {
            background: #2ECC71;
            border: none;
            border-radius: 8px;
            width: 36px;
            height: 36px;
            color: white;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-left: 8px;
            box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3);
            transition: all 0.2s ease;
        }

        .check-btn:active {
            transform: scale(0.95);
        }

        /* Profile Form Styles */
        .sex-selector {
            display: flex;
            background: rgba(39, 39, 42, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 4px;
            gap: 4px;
        }

        .sex-btn {
            flex: 1;
            background: transparent;
            border: none;
            color: #71717a;
            padding: 10px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .sex-btn.active {
            background: #2ECC71;
            color: white;
            box-shadow: 0 2px 8px rgba(46, 204, 113, 0.3);
        }

        .scroll-select {
            appearance: none;
            -webkit-appearance: none;
            background: rgba(39, 39, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #e4e4e7;
            padding: 12px;
            border-radius: 8px;
            font-size: 1em;
            text-align: center;
            width: 100%;
            cursor: pointer;
        }

        /* Wheel Picker Styles */
        .picker-container {
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(24, 24, 27, 0.6);
            /* Zinc 900 */
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            height: 100px;
            overflow: hidden;
            mask-image: linear-gradient(to bottom,
                    transparent,
                    black 20%,
                    black 80%,
                    transparent);
            -webkit-mask-image: linear-gradient(to bottom,
                    transparent,
                    black 20%,
                    black 80%,
                    transparent);
        }

        .picker-col {
            flex: 1;
            height: 100%;
            overflow-y: scroll;
            overflow-x: hidden;
            /* Prevent horizontal scroll */
            scroll-snap-type: y mandatory;
            position: relative;
            z-index: 1;
            /* Hide scrollbar */
            scrollbar-width: none;
            width: 100%;
        }

        .picker-col::-webkit-scrollbar {
            display: none;
        }

        .picker-list {
            padding-top: 30px;
            padding-bottom: 30px;
            width: 100%;
        }

        .picker-item {
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1em;
            color: #71717a;
            scroll-snap-align: center;
            transition: color 0.2s, transform 0.2s;
            font-weight: 500;
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
            white-space: nowrap;
        }

        .picker-highlight {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 40px;
            margin-top: -20px;
            background: rgba(255, 255, 255, 0.08);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            pointer-events: none;
            z-index: 0;
        }

        /* Active item simulation (handled by JS intersection usually, but center bar does the visual job) */
    </style>
</head>

<body>
    <!-- Page 1: Stats -->
    <div id="page1" class="page-content">
        <div class="container">
            <h1>üìä Stats</h1>

            <!-- Category Filter -->
            <div class="card" style="margin-bottom: 16px;">
                <div class="section-title">Filter by Category</div>
                <div class="chip-container" id="categoryFilterChips">
                    <div class="chip category-chip active" data-category="all"
                        onclick="filterEventTypesByCategory('all')">All</div>
                    <div class="chip category-chip" data-category="Nutrition"
                        onclick="filterEventTypesByCategory('Nutrition')">üçé Nutrition</div>
                    <div class="chip category-chip" data-category="Fitness"
                        onclick="filterEventTypesByCategory('Fitness')">üí™ Fitness</div>
                    <div class="chip category-chip" data-category="Health"
                        onclick="filterEventTypesByCategory('Health')">‚öñÔ∏è Health</div>
                    <div class="chip category-chip" data-category="Custom"
                        onclick="filterEventTypesByCategory('Custom')">‚≠ê Custom</div>
                </div>
            </div>

            <!-- Event Types List -->
            <div class="card">
                <div class="section-title">Event Types</div>
                <div id="eventTypesList" class="event-types-list">
                    <!-- Event types will be inserted here -->
                    <div class="empty-state">
                        <div class="empty-state-emoji">‚è≥</div>
                        <p>Loading event types...</p>
                    </div>
                </div>
            </div>

            <!-- Add Event Type Button (Fixed Bottom Right) -->
            <div style="position: fixed; bottom: 90px; right: 20px; z-index: 80;">
                <div style="display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: transform 0.2s ease;"
                    id="addEventTypeBtnContainer" onclick="openAddEventTypeModal()"
                    onmousedown="this.style.transform='scale(0.95)'" onmouseup="this.style.transform='scale(1)'"
                    onmouseleave="this.style.transform='scale(1)'">
                    <div
                        style="background: #2ECC71; width: 56px; height: 56px; border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(46, 204, 113, 0.4); transition: all 0.2s;">
                        <span style="font-size: 32px; color: #ffffff; line-height: 1;">+</span>
                    </div>
                    <span style="font-size: 10px; margin-top: 4px; color: #a1a1aa; font-weight: 500;">Add Type</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Page 2: Goals -->
    <div id="page2" class="page-content">
        <div class="container">
            <h1>üìà Insights</h1>

            <!-- Event Type Selection -->
            <div class="card">
                <div class="section-title"
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <span>Metrics</span>
                    <div style="display: flex; background: rgba(39, 39, 42, 0.6); border-radius: 8px; padding: 2px;">
                        <button onclick="setGoalsChartMode('time')" id="goalsModeTime"
                            style="background: #2ECC71; color: white; border: none; padding: 4px 12px; border-radius: 6px; font-size: 0.8em; cursor: pointer; transition: all 0.2s;">
                            Trend
                        </button>
                        <button onclick="setGoalsChartMode('correlation')" id="goalsModeCorrelation"
                            style="background: transparent; color: #a1a1aa; border: none; padding: 4px 12px; border-radius: 6px; font-size: 0.8em; cursor: pointer; transition: all 0.2s;">
                            Correlation
                        </button>
                    </div>
                </div>
                <div id="goalsEventTypeChips" class="chip-container" style="flex-wrap: wrap; gap: 8px;">
                    <!-- Event type chips will be inserted here -->
                    <div class="empty-state" style="padding: 20px 0;">
                        <p>Loading event types...</p>
                    </div>
                </div>
            </div>



            <!-- Aggregation Controls (shown when metrics selected) -->
            <div id="goalsAggregationCard" class="card" style="display: none;">
                <div class="section-title">Aggregation Settings</div>
                <div id="goalsAggregationControls" style="display: flex; flex-direction: column; gap: 12px;">
                    <!-- Per-series aggregation dropdowns inserted here -->
                </div>
            </div>

            <!-- Chart Container -->
            <div class="card">
                <!-- Time Range Selection -->
                <div style="margin-bottom: 20px;">
                    <div class="goals-range-selector">
                        <div class="goals-range-option" data-range="1d" onclick="setGoalsTimeRange('1d')">D</div>
                        <div class="goals-range-option" data-range="7d" onclick="setGoalsTimeRange('7d')">W</div>
                        <div class="goals-range-option active" data-range="30d" onclick="setGoalsTimeRange('30d')">M
                        </div>
                        <div class="goals-range-option" data-range="6m" onclick="setGoalsTimeRange('6m')">6M</div>
                        <div class="goals-range-option" data-range="1y" onclick="setGoalsTimeRange('1y')">Y</div>
                    </div>
                </div>

                <!-- Toggles (Right Aligned) -->
                <div style="margin-bottom: 10px; display: flex; justify-content: flex-end;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="goalsShowAverage" checked onchange="toggleGoalsAverage(this.checked)"
                            style="accent-color: #2ECC71; width: 16px; height: 16px; cursor: pointer;">
                        <label for="goalsShowAverage"
                            style="color: #a1a1aa; font-size: 0.85em; cursor: pointer; user-select: none;">Show
                            Avg</label>
                    </div>
                </div>
                <div id="goalsChartContainer" style="position: relative; width: 100%; min-height: 300px;">
                    <canvas id="goalsChart"></canvas>
                    <div id="goalsChartEmpty" class="empty-state"
                        style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <div class="empty-state-emoji">üìä</div>
                        <p>Select metrics above to see your data</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Page 3: Food Logging (Current Page) -->
    <div id="page3" class="page-content active">
        <div class="container">
            <!-- Header with back button and favorite -->
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                <button onclick="switchPage(1)"
                    style="background: rgba(39, 39, 42, 0.6); border: 1px solid #3f3f46; color: #e4e4e7; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 0.9em;">
                    ‚Üê Back
                </button>
                <div style="flex: 1;">
                    <h1 style="margin: 0; font-size: 1.5em;">üçΩÔ∏è Meal</h1>
                </div>
                <div id="mealFavoriteContainer">
                    <!-- Favorite button will be inserted here by JS -->
                </div>
            </div>

            <!-- Animation Overlay -->
            <div id="expansion-overlay"></div>

            <!-- Notification Toast -->
            <div id="notificationToast" class="notification-toast">
                <span>‚úÖ</span>
                <span id="notificationMessage">Message</span>
            </div>

            <!-- Food Entry Form -->
            <div class="card">
                <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
                    Log Food
                    <div style="display: flex; flex-direction: column; align-items: center; cursor: pointer; margin-right: -4px; transition: transform 0.2s ease, filter 0.2s ease;"
                        id="customBtnContainer" onclick="openCustomFoodModal(this)"
                        onmousedown="this.style.transform='scale(0.95)'" onmouseup="this.style.transform='scale(1)'"
                        onmouseleave="this.style.transform='scale(1)'">
                        <div
                            style="background: #2ECC71; width: 44px; height: 44px; border-radius: 10px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">
                            <span style="font-size: 28px; color: #ffffff; line-height: 1;">+</span>
                        </div>
                        <span style="font-size: 10px; margin-top: 4px; color: #a1a1aa; font-weight: 500;">Custom</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="foodSearch">Search Food (FatSecret)</label>
                    <input type="search" id="foodSearch" placeholder="Type to search (e.g. 'Apple')" autocomplete="off">
                    <div id="searchResults" class="search-results"></div>
                </div>

                <form id="foodForm">
                    <div class="form-group">
                        <label for="foodName">Food Name</label>
                        <input type="text" id="foodName" placeholder="Manual entry" required autocomplete="off">
                    </div>

                    <!-- Portion Control -->
                    <div class="form-group hidden" id="portionSection">
                        <div style="display: flex; gap: 10px;">
                            <div style="flex: 1;">
                                <label>Portion</label>
                                <input type="number" id="portionInput" placeholder="1" step="any" min="0">
                            </div>
                            <div style="flex: 1;">
                                <label>Unit</label>
                                <input type="text" id="unitInput" disabled
                                    style="background: rgba(24, 24, 27, 0.4); color: #71717a; cursor: not-allowed;">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Nutrition <button type="button" class="toggle-btn"
                                id="toggleNutrition">(Show)</button></label>
                        <div id="nutritionInputs" class="nutrition-grid hidden">
                            <div class="nutrition-item">
                                <label>Calories</label>
                                <input type="number" id="calInput" placeholder="0" min="0" step="1">
                            </div>
                            <div class="nutrition-item">
                                <label>Protein</label>
                                <input type="number" id="protInput" placeholder="0g" min="0" step="0.1">
                            </div>
                            <div class="nutrition-item">
                                <label>Carbs</label>
                                <input type="number" id="carbInput" placeholder="0g" min="0" step="0.1">
                            </div>
                            <div class="nutrition-item">
                                <label>Fat</label>
                                <input type="number" id="fatInput" placeholder="0g" min="0" step="0.1">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Meal Type</label>
                        <div class="meal-type-grid">
                            <button type="button" class="meal-type-btn active" data-value="breakfast">
                                <span class="emoji">üåÖ</span>
                                <span>Breakfast</span>
                            </button>
                            <button type="button" class="meal-type-btn" data-value="lunch">
                                <span class="emoji">üåû</span>
                                <span>Lunch</span>
                            </button>
                            <button type="button" class="meal-type-btn" data-value="dinner">
                                <span class="emoji">üåô</span>
                                <span>Dinner</span>
                            </button>
                            <button type="button" class="meal-type-btn" data-value="snack">
                                <span class="emoji">üçø</span>
                                <span>Snack</span>
                            </button>
                        </div>
                        <input type="hidden" id="mealType" value="breakfast" required>
                    </div>

                    <button type="submit" class="primary-btn">Add Meal</button>
                </form>
            </div>

            <!-- Today's Meals -->
            <div class="card">
                <div class="section-title">
                    Today's Meals
                    <span id="dailyTotal" class="daily-total">0 kcal</span>
                </div>
                <div id="mealsList" class="meals-list">
                    <!-- Meals will be inserted here -->
                </div>
            </div>
        </div>

    </div>

    <!-- Page 4: Me -->
    <div id="page4" class="page-content">
        <div class="container">
            <h1>üë§ Me</h1>

            <!-- Profile Setup Form (shown when no profile exists) -->
            <div id="profileSetupCard" class="card hidden">
                <div class="section-title">Set Up Your Profile</div>
                <form id="profileSetupForm" onsubmit="handleProfileSubmit(event)">
                    <!-- Sex -->
                    <div class="form-group">
                        <label>Sex</label>
                        <div class="sex-selector">
                            <button type="button" class="sex-btn" onclick="selectSex('male')"
                                id="btnSexMale">Male</button>
                            <button type="button" class="sex-btn" onclick="selectSex('female')"
                                id="btnSexFemale">Female</button>
                        </div>
                        <input type="hidden" id="profileSex" required>
                    </div>

                    <!-- Birthdate Wheel -->
                    <div class="form-group">
                        <label>Birthdate</label>
                        <!-- Hidden inputs to store real values -->
                        <input type="hidden" id="dobMonth">
                        <input type="hidden" id="dobDay">
                        <input type="hidden" id="dobYear">

                        <div class="picker-container">
                            <div class="picker-highlight"></div>

                            <!-- Month -->
                            <div class="picker-col" id="col_dobMonth">
                                <div class="picker-list" id="wheel_dobMonth"></div>
                            </div>

                            <!-- Day -->
                            <div class="picker-col" id="col_dobDay">
                                <div class="picker-list" id="wheel_dobDay"></div>
                            </div>

                            <!-- Year -->
                            <div class="picker-col" id="col_dobYear">
                                <div class="picker-list" id="wheel_dobYear"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Height Wheel -->
                    <div class="form-group">
                        <label>Height</label>
                        <input type="hidden" id="profileHeightFeet">
                        <input type="hidden" id="profileHeightInches">

                        <div class="picker-container">
                            <div class="picker-highlight"></div>

                            <!-- Feet -->
                            <div class="picker-col" id="col_heightFeet">
                                <div class="picker-list" id="wheel_heightFeet"></div>
                            </div>

                            <!-- Inches -->
                            <div class="picker-col" id="col_heightInches">
                                <div class="picker-list" id="wheel_heightInches"></div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="profileWeight">Current Weight (lbs)</label>
                        <input type="number" id="profileWeight" placeholder="Enter weight" min="1" step="0.1" required
                            style="padding: 12px; background: rgba(39, 39, 42, 0.6); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: #e4e4e7; font-size: 1em; width: 100%; box-sizing: border-box;">
                    </div>

                    <button type="submit" class="primary-btn">Save Profile</button>
                </form>
            </div>

            <!-- Profile Display (shown when profile exists) -->
            <div id="profileDisplayCard" class="card hidden">
                <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Profile</span>
                    <button onclick="showProfileEditForm()"
                        style="background: rgba(39, 39, 42, 0.6); border: 1px solid #3f3f46; color: #a1a1aa; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                        ‚úèÔ∏è Edit
                    </button>
                </div>

                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-top: 16px;">
                    <div
                        style="background: rgba(39, 39, 42, 0.4); border-radius: 12px; padding: 16px; text-align: center;">
                        <div style="color: #a1a1aa; font-size: 0.85em; margin-bottom: 4px;">Sex</div>
                        <div id="profileDisplaySex"
                            style="color: #e4e4e7; font-size: 1.2em; font-weight: 600; text-transform: capitalize;">-
                        </div>
                    </div>
                    <div
                        style="background: rgba(39, 39, 42, 0.4); border-radius: 12px; padding: 16px; text-align: center;">
                        <div style="color: #a1a1aa; font-size: 0.85em; margin-bottom: 4px;">Age</div>
                        <div id="profileDisplayAge" style="color: #e4e4e7; font-size: 1.2em; font-weight: 600;">-</div>
                    </div>
                    <div
                        style="background: rgba(39, 39, 42, 0.4); border-radius: 12px; padding: 16px; text-align: center;">
                        <div style="color: #a1a1aa; font-size: 0.85em; margin-bottom: 4px;">Height</div>
                        <div id="profileDisplayHeight" style="color: #e4e4e7; font-size: 1.2em; font-weight: 600;">-
                        </div>
                    </div>
                    <div
                        style="background: rgba(39, 39, 42, 0.4); border-radius: 12px; padding: 16px; text-align: center;">
                        <div style="color: #a1a1aa; font-size: 0.85em; margin-bottom: 4px;">Weight</div>
                        <div id="profileDisplayWeight" style="color: #e4e4e7; font-size: 1.2em; font-weight: 600;">-
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="profileLoadingCard" class="card">
                <div class="empty-state">
                    <div class="empty-state-emoji">‚è≥</div>
                    <p>Loading profile...</p>
                </div>
            </div>

            <!-- Goals Section -->
            <div id="goalsCard" class="card hidden">
                <div class="section-title"
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <span>üéØ Daily Goals</span>
                    <button onclick="openAddGoalModal()"
                        style="background: #2ECC71; color: white; border: none; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3);">
                        <span style="font-size: 1.2em;">+</span>
                    </button>
                </div>
                <div id="goalsList" style="display: flex; flex-direction: column; gap: 12px;">
                    <!-- Goals will be inserted here -->
                </div>

                <button onclick="openFitnessGoalsWizard()" class="secondary-btn"
                    style="width: 100%; margin-top: 12px; display: flex; align-items: center; justify-content: center; gap: 8px; background: rgba(39, 39, 42, 0.4); border: 1px dashed rgba(255, 255, 255, 0.2); color: #a1a1aa; padding: 12px; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                    <span>‚ú®</span> Create Fitness Plan
                </button>
            </div>
        </div>
    </div>

    <!-- Page 5: Settings -->
    <div id="page5" class="page-content">
        <div class="container">
            <h1>‚öôÔ∏è Settings</h1>

            <div class="card">
                <div class="section-title">Account</div>
                <div class="user-id-container" id="userIdDisplay"
                    style="background: rgba(39, 39, 42, 0.4); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 16px; text-align: center; cursor: pointer; transition: all 0.2s ease;">
                    <div style="color: #a1a1aa; font-size: 0.9em; margin-bottom: 4px;">User ID</div>
                    <div style="color: #2ECC71; font-size: 1.5em; font-weight: 700; font-family: monospace;">Loading...
                    </div>
                    <div
                        style="color: #71717a; font-size: 0.8em; margin-top: 8px; display: flex; align-items: center; justify-content: center; gap: 4px;">
                        <span>‚úèÔ∏è</span> Tap to edit or link device
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="section-title">System</div>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div style="color: #a1a1aa; font-size: 0.9em; margin-bottom: 8px;">
                        Troubleshooting issues? Try forcing an update to clear the cache.
                    </div>
                    <button onclick="forceUpdate()" class="primary-btn"
                        style="background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.5);">
                        Force Update
                    </button>
                    <div style="text-align: center; color: #52525b; font-size: 0.8em; margin-top: 8px;">
                        Build: 1.0.0
                    </div>
                    <div style="text-align: center; color: #52525b; font-size: 0.8em; margin-top: 8px;">
                        Build: 1.0.0
                    </div>

                </div>
            </div>

            <div class="card">
                <div class="section-title">Coming Soon</div>
                <div class="empty-state">
                    <div class="empty-state-emoji">‚öôÔ∏è</div>
                    <p>More settings will be available soon</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Page 6: Event Tracking (Dynamic) -->
    <div id="page6" class="page-content">
        <div class="container">
            <!-- Header with back button -->
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                <button onclick="closeEventTrackingPage()"
                    style="background: rgba(39, 39, 42, 0.6); border: 1px solid #3f3f46; color: #e4e4e7; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 0.9em;">
                    ‚Üê Back
                </button>
                <h1 id="eventTrackingTitle" style="margin: 0; flex: 1;">Event Tracking</h1>
                <div id="eventTrackingHeaderActions"></div>
            </div>

            <!-- Log Event Form -->
            <div class="card">
                <div class="section-title">Log Event</div>
                <form id="eventTrackingForm" onsubmit="handleEventSubmit(event)">
                    <div id="eventFormFields">
                        <!-- Dynamic form fields will be inserted here -->
                    </div>
                    <button type="submit" class="primary-btn">Add Event</button>
                </form>
            </div>

            <!-- Event History -->
            <div class="card">
                <div class="section-title">History</div>
                <div id="eventHistoryList" class="meals-list">
                    <!-- Event history will be inserted here -->
                    <div class="empty-state">
                        <div class="empty-state-emoji">üìã</div>
                        <p>No events logged yet</p>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Page 7: Home (Template) -->
    <div id="page7" class="page-content center-page">
        <div class="container">
            <h1>üè† Home</h1>

            <!-- Favorites Section -->
            <div id="favoritesSection" class="card hidden">
                <div class="section-title">‚≠ê Favorites</div>
                <div id="favoritesList" class="event-types-list">
                    <!-- Favorites will be inserted here -->
                </div>
            </div>

            <div class="card">
                <div class="section-title">Welcome</div>
                <div class="empty-state">
                    <div class="empty-state-emoji">üëã</div>
                    <p>Welcome to LifeStats</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Tab Bar -->
    <nav class="bottom-tab-bar">
        <div class="tab-item" onclick="switchPage(1)">
            <div class="tab-icon">üìä</div>
            <div class="tab-label">Stats</div>
        </div>
        <div class="tab-item" onclick="switchPage(2)">
            <div class="tab-icon">üìà</div>
            <div class="tab-label">Insights</div>
        </div>
        <div class="tab-item active" onclick="switchPage(7)">
            <div class="tab-icon">üè†</div>
            <div class="tab-label">Home</div>
        </div>
        <div class="tab-item" onclick="switchPage(4)">
            <div class="tab-icon">üë§</div>
            <div class="tab-label">Me</div>
        </div>
        <div class="tab-item" onclick="switchPage(5)">
            <div class="tab-icon">‚öôÔ∏è</div>
            <div class="tab-label">Settings</div>
        </div>
    </nav>

    <!-- ... (Modals remain unchanged) ... -->
    <!-- Custom Food Modal -->
    <div id="customFoodModalOverlay" class="modal-overlay hidden custom-food-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Create Custom Food</div>
                <button class="close-btn" onclick="closeCustomFoodModal()">&times;</button>
            </div>
            <!-- ... (rest of custom food modal) ... -->

            <!-- Scripts -->
            <script src="/storage.js"></script>
            <script>
                // ... (Existing scripts) ...

                // ===== GOALS TAB CHARTING =====
                let goalsChart = null;
                let goalsSelectedEventTypes = [];
                let goalsTimeRange = '30d';
                let goalsAggregationOverrides = {};
                let goalsFieldOverrides = {};
                let goalsShowAverage = true; // Default enabled
                let goalsCachedData = null;
                let goalsChartMode = 'time'; // 'time' or 'correlation'

                // Available fields for meal type
                const mealFields = [
                    { value: 'calories', label: 'Calories (kcal)' },
                    { value: 'protein', label: 'Protein (g)' },
                    { value: 'carbs', label: 'Carbs (g)' },
                    { value: 'fat', label: 'Fat (g)' },
                    { value: 'fiber', label: 'Fiber (g)' },
                    { value: 'sugar', label: 'Sugar (g)' },
                    { value: 'sodium', label: 'Sodium (mg)' },
                    { value: 'cholesterol', label: 'Cholesterol (mg)' },
                    { value: 'saturatedFat', label: 'Saturated Fat (g)' },
                    { value: 'transFat', label: 'Trans Fat (g)' },
                    { value: 'calcium', label: 'Calcium (mg)' },
                    { value: 'iron', label: 'Iron (mg)' },
                    { value: 'potassium', label: 'Potassium (mg)' },
                    { value: 'vitaminC', label: 'Vitamin C (mg)' },
                    { value: 'vitaminD', label: 'Vitamin D (mcg)' }
                ];

                function initGoalsTab() {
                    // Populate event type chips when allEventTypes is loaded
                    if (typeof allEventTypes !== 'undefined' && allEventTypes.length > 0) {
                        renderGoalsEventTypeChips();
                    }
                }

                function renderGoalsEventTypeChips() {
                    const container = document.getElementById('goalsEventTypeChips');
                    if (!container) return;

                    // Filter and sort types: Favorites first, then Last Used (desc), then Alphabetical
                    const chartableTypes = (typeof allEventTypes !== 'undefined' ? allEventTypes : [])
                        .filter(et => et.isActive !== false)
                        .sort((a, b) => {
                            // 1. Favorites first
                            if (a.isFavorite && !b.isFavorite) return -1;
                            if (!a.isFavorite && b.isFavorite) return 1;

                            // 2. Last Used (descending)
                            const lastUsedA = a.lastUsed || 0;
                            const lastUsedB = b.lastUsed || 0;
                            if (lastUsedA !== lastUsedB) {
                                return lastUsedB - lastUsedA;
                            }

                            // 3. Alphabetical fallback
                            return a.name.localeCompare(b.name);
                        });

                    if (chartableTypes.length === 0) {
                        container.innerHTML = `
                            <div class="empty-state" style="padding: 20px 0;">
                                <p>No event types available. Create some on the Stats tab!</p>
                            </div>
                        `;
                        return;
                    }

                    container.innerHTML = chartableTypes.map(et => {
                        const isSelected = goalsSelectedEventTypes.includes(et.id);
                        const activeStyle = isSelected
                            ? `background: ${et.color}25; border-color: ${et.color}; color: ${et.color};`
                            : '';
                        return `
                            <div class="chip goals-metric-chip ${isSelected ? 'selected' : ''}" 
                                 data-event-type-id="${et.id}"
                                 style="${activeStyle}"
                                 onclick="toggleGoalsEventType('${et.id}')">
                                ${et.icon} ${et.name}
                            </div>
                        `;
                    }).join('');
                }

                function toggleGoalsEventType(eventTypeId) {
                    const index = goalsSelectedEventTypes.indexOf(eventTypeId);
                    if (index > -1) {
                        goalsSelectedEventTypes.splice(index, 1);
                        delete goalsAggregationOverrides[eventTypeId];
                    } else {
                        goalsSelectedEventTypes.push(eventTypeId);
                    }
                    renderGoalsEventTypeChips();
                    updateGoalsAggregationControls();
                    loadGoalsChartData();
                }

                function setGoalsTimeRange(range) {
                    goalsTimeRange = range;

                    // Update chip styles
                    document.querySelectorAll('.goals-range-option').forEach(chip => {
                        chip.classList.remove('active');
                        if (chip.dataset.range === range) {
                            chip.classList.add('active');
                        }
                    });

                    loadGoalsChartData();
                }

                function updateGoalsAggregationControls() {
                    const card = document.getElementById('goalsAggregationCard');
                    const container = document.getElementById('goalsAggregationControls');

                    if (goalsSelectedEventTypes.length === 0) {
                        card.style.display = 'none';
                        return;
                    }

                    card.style.display = 'block';

                    const types = (typeof allEventTypes !== 'undefined' ? allEventTypes : [])
                        .filter(et => goalsSelectedEventTypes.includes(et.id));

                    container.innerHTML = types.map(et => {
                        const currentAgg = goalsAggregationOverrides[et.id] || et.aggregationType || 'sum';
                        const currentField = goalsFieldOverrides[et.id];

                        // Build field selector for meal type or event types with fieldSchema
                        let fieldSelector = '';
                        if (et.id === 'meal') {
                            const selectedField = currentField || 'calories';
                            fieldSelector = `
                                <select 
                                    onchange="setGoalsField('${et.id}', this.value)"
                                    style="padding: 8px 12px; background: rgba(39, 39, 42, 0.6); border: 1px solid #3f3f46; border-radius: 8px; color: #e4e4e7; font-size: 0.9em; min-width: 120px;">
                                    ${mealFields.map(f => `<option value="${f.value}" ${selectedField === f.value ? 'selected' : ''}>${f.label}</option>`).join('')}
                                </select>
                            `;
                        } else if (et.fieldSchema && et.fieldSchema.fields && et.fieldSchema.fields.length > 1) {
                            // For event types with multiple fields in their schema
                            const numericFields = et.fieldSchema.fields.filter(f => f.type === 'number');
                            if (numericFields.length > 1) {
                                const selectedField = currentField || numericFields[0].name;
                                fieldSelector = `
                                    <select 
                                        onchange="setGoalsField('${et.id}', this.value)"
                                        style="padding: 8px 12px; background: rgba(39, 39, 42, 0.6); border: 1px solid #3f3f46; border-radius: 8px; color: #e4e4e7; font-size: 0.9em; min-width: 100px;">
                                        ${numericFields.map(f => `<option value="${f.name}" ${selectedField === f.name ? 'selected' : ''}>${f.label || f.name}</option>`).join('')}
                                    </select>
                                `;
                            }
                        }

                        return `
                            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                <span style="flex: 1; color: #e4e4e7; min-width: 100px;">${et.icon} ${et.name}</span>
                                ${fieldSelector}
                                <select 
                                    onchange="setGoalsAggregation('${et.id}', this.value)"
                                    style="padding: 8px 12px; background: rgba(39, 39, 42, 0.6); border: 1px solid #3f3f46; border-radius: 8px; color: #e4e4e7; font-size: 0.9em;">
                                    <option value="sum" ${currentAgg === 'sum' || currentAgg === 'sum_today' ? 'selected' : ''}>Sum</option>
                                    <option value="average" ${currentAgg === 'average' ? 'selected' : ''}>Average</option>
                                    <option value="count" ${currentAgg === 'count' ? 'selected' : ''}>Count</option>
                                    <option value="last" ${currentAgg === 'last' ? 'selected' : ''}>Last Value</option>
                                    <option value="max" ${currentAgg === 'max' ? 'selected' : ''}>Max</option>
                                    <option value="min" ${currentAgg === 'min' ? 'selected' : ''}>Min</option>
                                </select>
                            </div>
                        `;
                    }).join('');
                }

                function setGoalsField(eventTypeId, fieldName) {
                    goalsFieldOverrides[eventTypeId] = fieldName;
                    loadGoalsChartData();
                }

                function setGoalsAggregation(eventTypeId, aggregationType) {
                    goalsAggregationOverrides[eventTypeId] = aggregationType;
                    loadGoalsChartData();
                }

                function getGoalsDateRange() {
                    const now = new Date();
                    let startDate, endDate;

                    endDate = new Date(now);
                    endDate.setHours(23, 59, 59, 999);

                    switch (goalsTimeRange) {
                        case '1d':
                            startDate = new Date(now.getTime() - 1 * 24 * 60 * 60 * 1000);
                            break;
                        case '7d':
                            startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                            break;
                        case '30d':
                            startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                            break;
                        case '6m':
                            startDate = new Date(now);
                            startDate.setMonth(startDate.getMonth() - 5);
                            break;
                        case '1y':
                            startDate = new Date(now);
                            startDate.setFullYear(startDate.getFullYear() - 1);
                            break;
                        default:
                            startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    }

                    startDate.setHours(0, 0, 0, 0);

                    return {
                        startDate: startDate.getTime(),
                        endDate: endDate.getTime()
                    };
                }

                async function loadGoalsChartData() {
                    const emptyState = document.getElementById('goalsChartEmpty');
                    const canvas = document.getElementById('goalsChart');

                    if (goalsSelectedEventTypes.length === 0) {
                        emptyState.style.display = 'flex';
                        if (goalsChart) {
                            goalsChart.destroy();
                            goalsChart = null;
                        }
                        return;
                    }

                    emptyState.style.display = 'none';

                    const userId = localStorage.getItem('lifestats_userId');
                    if (!userId) return;

                    const { startDate, endDate } = getGoalsDateRange();
                    const granularity = goalsTimeRange === '1d' ? 'hour' : 'day';
                    const timezoneOffset = new Date().getTimezoneOffset();

                    try {
                        let url = `/api/chart-data?userId=${userId}&eventTypeIds=${goalsSelectedEventTypes.join(',')}&startDate=${startDate}&endDate=${endDate}&granularity=${granularity}&timezoneOffset=${timezoneOffset}`;

                        if (Object.keys(goalsAggregationOverrides).length > 0) {
                            url += `&aggregations=${encodeURIComponent(JSON.stringify(goalsAggregationOverrides))}`;
                        }

                        if (Object.keys(goalsFieldOverrides).length > 0) {
                            url += `&fields=${encodeURIComponent(JSON.stringify(goalsFieldOverrides))}`;
                        }

                        const response = await fetch(url);
                        const data = await response.json();

                        if (data.error) {
                            console.error('Chart data error:', data.error);
                            return;
                        }

                        goalsCachedData = data;
                        renderGoalsChart(data);
                    } catch (error) {
                        console.error('Error loading chart data:', error);
                    }
                }

                function toggleGoalsAverage(enabled) {
                    goalsShowAverage = enabled;
                    if (goalsCachedData) {
                        renderGoalsChart(goalsCachedData);
                    }
                }

                function setGoalsChartMode(mode) {
                    goalsChartMode = mode;

                    // Update Mode Toggle UI
                    const btnTime = document.getElementById('goalsModeTime');
                    const btnCorr = document.getElementById('goalsModeCorrelation');

                    if (mode === 'time') {
                        btnTime.style.background = '#2ECC71';
                        btnTime.style.color = 'white';
                        btnCorr.style.background = 'transparent';
                        btnCorr.style.color = '#a1a1aa';
                    } else {
                        btnCorr.style.background = '#2ECC71';
                        btnCorr.style.color = 'white';
                        btnTime.style.background = 'transparent';
                        btnTime.style.color = '#a1a1aa';
                    }

                    if (goalsCachedData) {
                        renderGoalsChart(goalsCachedData);
                    }
                }

                function renderGoalsChart(data) {
                    const canvas = document.getElementById('goalsChart');
                    const ctx = canvas.getContext('2d');

                    if (goalsChart) {
                        goalsChart.destroy();
                    }

                    if (goalsChartMode === 'correlation') {
                        // CORRELATION MODE (SCATTER)
                        if (data.datasets.length !== 2) {
                            alert("Please select exactly 2 metrics for Correlation mode.");
                            setGoalsChartMode('time'); // Fallback
                            return;
                        }

                        const ds1 = data.datasets[0];
                        const ds2 = data.datasets[1];
                        const scatterData = [];

                        // Match data points by index (assuming aligned time buckets)
                        for (let i = 0; i < ds1.data.length; i++) {
                            const v1 = ds1.data[i];
                            const v2 = ds2.data[i];

                            if (v1 !== null && v1 !== undefined && v2 !== null && v2 !== undefined) {
                                scatterData.push({
                                    x: v1,
                                    y: v2,
                                    label: data.labels[i] // Store date for tooltip
                                });
                            }
                        }

                        // Create scatter dataset
                        const scatterDataset = {
                            label: `${ds1.name} vs ${ds2.name}`,
                            data: scatterData,
                            backgroundColor: ds1.color, // Or mix? Use ds1 for now
                            borderColor: ds1.color,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        };

                        goalsChart = new Chart(ctx, {
                            type: 'scatter',
                            data: {
                                datasets: [scatterDataset]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    x: {
                                        type: 'linear',
                                        position: 'bottom',
                                        title: {
                                            display: true,
                                            text: `${ds1.name} (${ds1.unit || ''})`,
                                            color: '#a1a1aa'
                                        },
                                        grid: {
                                            color: 'rgba(255, 255, 255, 0.1)'
                                        },
                                        ticks: { color: '#a1a1aa' }
                                    },
                                    y: {
                                        type: 'linear',
                                        position: 'left',
                                        title: {
                                            display: true,
                                            text: `${ds2.name} (${ds2.unit || ''})`,
                                            color: '#a1a1aa'
                                        },
                                        grid: {
                                            color: 'rgba(255, 255, 255, 0.1)'
                                        },
                                        ticks: { color: '#a1a1aa' }
                                    }
                                },
                                plugins: {
                                    legend: { display: false },
                                    tooltip: {
                                        backgroundColor: 'rgba(24, 24, 27, 0.9)',
                                        titleColor: '#fff',
                                        bodyColor: '#e4e4e7',
                                        borderColor: '#3f3f46',
                                        borderWidth: 1,
                                        padding: 12,
                                        callbacks: {
                                            title: function (context) {
                                                const pt = context[0].raw;
                                                // format date based on label
                                                return pt.label.replace('T00:00:00', '');
                                            },
                                            label: function (context) {
                                                const pt = context.raw;
                                                return [
                                                    `${ds1.name}: ${pt.x} ${ds1.unit || ''}`,
                                                    `${ds2.name}: ${pt.y} ${ds2.unit || ''}`
                                                ];
                                            }
                                        }
                                    }
                                }
                            }
                        });


                    } else {
                        // TIME SERIES MODE (Existing Logic)

                        // Build datasets for Chart.js
                        let datasets = [];

                        data.datasets.forEach((ds, index) => {
                            // Main Dataset (Bar)
                            datasets.push({
                                label: `${ds.icon || ''} ${ds.name}`,
                                data: ds.data,
                                backgroundColor: ds.color,
                                borderRadius: 4,
                                barThickness: goalsTimeRange === '1y' || goalsTimeRange === '6m' ? 3 : 'flex',
                                maxBarThickness: 40,
                                yAxisID: index === 0 ? 'y0' : 'y1',
                                order: 1 // Render bars above (in front of) lines
                            });

                            // Average Line (if enabled)
                            if (goalsShowAverage) {
                                const validValues = ds.data.filter(v => v !== null && v !== undefined);
                                if (validValues.length > 0) {
                                    const sum = validValues.reduce((a, b) => a + b, 0);
                                    const avg = sum / validValues.length;
                                    const avgData = Array(ds.data.length).fill(avg);

                                    datasets.push({
                                        label: `${ds.name} (Avg)`,
                                        data: avgData,
                                        type: 'line',
                                        borderColor: ds.color, // Use same color
                                        borderWidth: 1,
                                        borderDash: [5, 5],
                                        pointRadius: 0,
                                        pointHoverRadius: 0,
                                        fill: false,
                                        yAxisID: index === 0 ? 'y0' : 'y1',
                                        order: 2, // Render line below (behind) bars
                                        tooltip: { enabled: false } // Don't show tooltip for average line to keep it clean? Or show it? Let's hide to avoid clutter.
                                    });
                                }
                            }
                        });

                        // Determine if we need multiple Y axes
                        // If ranges differ by more than 10x, use separate axes
                        const ranges = data.datasets.map(ds => {
                            const validData = ds.data.filter(v => v !== null);
                            if (validData.length === 0) return { min: 0, max: 0 };
                            return {
                                min: Math.min(...validData),
                                max: Math.max(...validData)
                            };
                        });

                        // Build scales configuration
                        const scales = {
                            x: {
                                grid: {
                                    display: false,
                                    drawBorder: false
                                },
                                ticks: {
                                    color: '#a1a1aa',
                                    font: {
                                        size: 11
                                    },
                                    maxRotation: 0,
                                    autoSkip: goalsTimeRange !== '7d',
                                    maxTicksLimit: goalsTimeRange === '1d' ? 6 : (goalsTimeRange === '7d' ? 8 : (goalsTimeRange === '30d' ? 5 : (goalsTimeRange === '6m' ? 6 : 12))),
                                    callback: function (val, index) {
                                        const label = this.getLabelForValue(val); // e.g., "2026-01-18 14:00" or "2026-01-18"
                                        // Ensure label is parsed as Local Time
                                        const dateStr = label.includes(':') ? label.replace(' ', 'T') : label + 'T00:00:00';
                                        const date = new Date(dateStr);

                                        if (goalsTimeRange === '1d') {
                                            // 12am, 6am, 12pm, 6pm
                                            const hours = date.getHours();
                                            if (hours === 0) return '12am';
                                            if (hours === 6) return '6am';
                                            if (hours === 12) return '12pm';
                                            if (hours === 18) return '6pm';
                                            // Return empty string for others to keep neat if not auto-skipped
                                            return '';
                                        } else if (goalsTimeRange === '7d') {
                                            // Mon, Tue... Sun
                                            return date.toLocaleDateString('en-US', { weekday: 'short' });
                                        } else if (goalsTimeRange === '30d') {
                                            // Number every ~7 days: 21, 28, 4, 11...
                                            // Actually easiest is to just show dates. 
                                            // The user said "see 21, 28,, 4, 11, 18 labeled".
                                            // We can just return the date number. autoSkip handles density.
                                            return date.getDate();
                                        } else {
                                            // 6M, 1Y: Show Month names tick when month changes
                                            // With autoSkip, simple month name is fine.
                                            return date.toLocaleDateString('en-US', { month: 'short' });
                                        }
                                    }
                                }
                            }
                        };

                        data.datasets.forEach((ds, index) => {
                            const position = index === 0 ? 'left' : 'right';
                            scales[`y${index}`] = {
                                type: 'linear',
                                display: true,
                                position: position,
                                grid: {
                                    color: index === 0 ? 'rgba(255, 255, 255, 0.1)' : 'transparent'
                                },
                                ticks: {
                                    color: ds.color
                                },
                                title: {
                                    display: data.datasets.length > 1,
                                    text: ds.unit || ds.name,
                                    color: ds.color
                                }
                            };
                        });

                        goalsChart = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: data.labels,
                                datasets: datasets
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    mode: 'index',
                                    intersect: false
                                },
                                plugins: {
                                    legend: {
                                        display: true,
                                        position: 'top',
                                        labels: {
                                            color: '#e4e4e7',
                                            usePointStyle: true,
                                            padding: 20,
                                            filter: function (item, chart) {
                                                // Hide average lines from legend
                                                // We can check if the text ends with "(Avg)"
                                                return !item.text.includes('(Avg)');
                                            }
                                        }
                                    },
                                    tooltip: {
                                        backgroundColor: 'rgba(39, 39, 42, 0.95)',
                                        titleColor: '#e4e4e7',
                                        bodyColor: '#a1a1aa',
                                        borderColor: 'rgba(255, 255, 255, 0.1)',
                                        borderWidth: 1,
                                        padding: 12,
                                        callbacks: {
                                            title: function (context) {
                                                // Tooltip title formatting
                                                const label = context[0].label;
                                                const dateStr = label.includes(':') ? label.replace(' ', 'T') : label + 'T00:00:00';
                                                const date = new Date(dateStr);

                                                if (goalsTimeRange === '1d') {
                                                    return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                                                } else if (goalsTimeRange === '1y' || goalsTimeRange === '6m') {
                                                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                                                }
                                                return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                                            },
                                            label: function (context) {
                                                const ds = data.datasets[context.datasetIndex];
                                                const value = context.parsed.y;
                                                if (value === null) return `${ds.name}: No data`;
                                                // formatting for small/large numbers
                                                let displayVal = value;
                                                if (value % 1 !== 0) displayVal = value.toFixed(1);
                                                return `${ds.name}: ${displayVal} ${ds.unit || ''}`;
                                            }
                                        }
                                    }
                                },
                                scales: scales
                            }
                        });
                    }
                }

                // ===== EVENT TYPE FAVORITING =====
                async function toggleFavoriteEventType(eventTypeId, currentStatus) {
                    const newStatus = !currentStatus;
                    const userId = localStorage.getItem('lifestats_userId');

                    if (!userId) return; // Should not happen

                    // Optimistic Update
                    if (currentEventType && currentEventType.id === eventTypeId) {
                        currentEventType.isFavorite = newStatus;
                        updateFavoriteButtonState(newStatus);
                    }

                    // Also update in allEventTypes array to reflect locally immediately
                    const etIndex = allEventTypes.findIndex(et => et.id === eventTypeId);
                    if (etIndex !== -1) {
                        allEventTypes[etIndex].isFavorite = newStatus;
                    }

                    try {
                        // Use the new dedicated endpoint for toggling favorites (System & Custom)
                        await fetch(`/api/event-types/${eventTypeId}/favorite?userId=${userId}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ isFavorite: newStatus })
                        });

                        // Refresh lists - MUST pass userId so favorites are returned correctly
                        loadEventTypes(userId);

                    } catch (error) {
                        console.error('Error toggling favorite:', error);
                        // Revert optimistic update
                        if (currentEventType && currentEventType.id === eventTypeId) {
                            currentEventType.isFavorite = currentStatus;
                            updateFavoriteButtonState(currentStatus);
                        }
                    }
                }

                function updateFavoriteButtonState(isFavorite) {
                    const btn = document.getElementById('favoriteBtn');
                    if (btn) {
                        btn.innerHTML = isFavorite ? '‚òÖ' : '‚òÜ';
                        btn.style.color = isFavorite ? '#FFD700' : '#a1a1aa';
                    }
                }

                function renderHomeFavorites() {
                    const favoritesContainer = document.getElementById('favoritesSection');
                    const list = document.getElementById('favoritesList');
                    if (!favoritesContainer || !list) return;

                    const favorites = allEventTypes.filter(et => et.isFavorite);

                    if (favorites.length > 0) {
                        favoritesContainer.classList.remove('hidden');
                        // Reuse existing display logic but targeting a specific container
                        // We'll manually generate HTML here to avoid refactoring `displayEventTypes` too much if it relies on global ID
                        // Actually `displayEventTypes` writes to `eventTypesList`.
                        // Let's create a helper `generateEventTypesHTML`

                        // For now, I'll essentially copy the mapping logic or refactor `displayEventTypes`.
                        // Refactoring `displayEventTypes` is cleaner.
                        list.innerHTML = generateEventTypesHTML(favorites);
                    } else {
                        favoritesContainer.classList.add('hidden');
                    }
                }

                function generateEventTypesHTML(eventTypes) {
                    return eventTypes.map(et => {
                        let rightSideContent = '';
                        const trackingType = et.trackingType || 'count';

                        if (trackingType === 'count') {
                            rightSideContent = `
                        <button class="quick-log-btn" onclick="quickLogEvent(event, '${et.id}', '${et.category}', ${JSON.stringify(et).replace(/"/g, "&quot;")})"
                            style="background: #2ECC71; border: none; border-radius: 50%; width: 40px; height: 40px; color: white; font-size: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3);">
                            +
                        </button>
                    `;
                        } else if (trackingType === 'rating') {
                            rightSideContent = `
                        <div class="rating-container" id="rating_container_home_${et.id}" data-rating="0" style="display: flex; align-items: center;" onclick="event.stopPropagation()">
                            <div style="display: flex;">
                                ${[1, 2, 3, 4, 5].map(i => `
                                    <span class="rating-star-btn" id="star_home_${et.id}_${i}" onclick="selectRating('${et.id}', ${i}, 'home')">‚òÖ</span>
                                `).join('')}
                            </div>
                            <button class="check-btn" onclick="submitRating('${et.id}', '${et.category}', ${JSON.stringify(et).replace(/"/g, "&quot;")}, 'home')">
                                ‚úì
                            </button>
                        </div>
                    `;
                        } else if (trackingType === 'number') {
                            rightSideContent = `
                        <div style="display: flex; gap: 8px; align-items: center;" onclick="event.stopPropagation()">
                            <input type="number" 
                                   id="quick_input_home_${et.id}"
                                   placeholder="#" 
                                   style="width: 60px; padding: 6px; border-radius: 8px; border: 1px solid #3f3f46; background: rgba(0,0,0,0.2); color: white; text-align: center;"
                                   onclick="event.stopPropagation()">
                            <button onclick="quickLogEventNumber(event, '${et.id}', '${et.category}', ${JSON.stringify(et).replace(/"/g, "&quot;")}, 'home')"
                                    style="background: #2ECC71; border: none; border-radius: 8px; padding: 6px 12px; color: white; cursor: pointer;">
                                ‚úì
                            </button>
                        </div>
                    `;
                        }

                        // Note: We don't have today's stats passed in easily here unless we fetch them globally.
                        // For simplicity, we might skip the "Today: X" text on Home for now or pass it if available.
                        // The `todaysStats` variable is local to `loadEventTypes`. We should elevate it to global scope.

                        let statsHtml = '';
                        // Access global todaysStatsCache if we create one
                        if (window.todaysStatsCache && window.todaysStatsCache[et.id] && window.todaysStatsCache[et.id].value > 0) {
                            const stat = window.todaysStatsCache[et.id];
                            const unit = stat.unit || et.primaryUnit || '';
                            statsHtml = `<div style="font-size: 0.85em; color: #a1a1aa; margin-top: 4px;">Today: <span style="color: ${et.color}; font-weight: bold;">${parseFloat(stat.value.toFixed(1))} ${unit}</span></div>`;
                        }

                        return `
                <div class="event-type-row" data-category="${et.category}" onclick='openEventTrackingPage(${JSON.stringify(et).replace(/'/g, "&apos;")})' style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div class="event-type-icon" style="background: ${et.color}20; color: ${et.color};">
                            ${et.icon || 'üìä'}
                        </div>
                        <div class="event-type-info">
                            <div class="event-type-name">${et.name}</div>
                            <div class="event-type-meta">
                                <span class="event-type-category">${et.category}</span>
                            </div>
                            ${statsHtml}
                        </div>
                    </div>
                    <div class="event-type-actions">
                        ${rightSideContent}
                    </div>
                </div>
            `}).join('');
                }

                // Update handling of quick log to support home page IDs (optional, but good for robustness)
                // I updated IDs in generateEventTypesHTML to have '_home' suffix to avoid ID collisions if same event is on multiple tabs (though pages are hidden, IDs must be unique)


                // Override switchPage to refresh favorites
                window.originalSwitchPage = window.switchPage;
                window.switchPage = function (pageNumber) {
                    if (window.originalSwitchPage) window.originalSwitchPage(pageNumber);
                    if (pageNumber === 7) {
                        renderHomeFavorites();
                    }
                    if (pageNumber === 2) {
                        // Initialize Goals tab when navigating to it
                        if (typeof initGoalsTab === 'function') {
                            initGoalsTab();
                        }
                    }
                }

                // Init global cache
                window.todaysStatsCache = {};

            </script>


            <form id="customFoodForm" onsubmit="handleCustomFoodSubmit(event)">
                <!-- Header Info -->
                <div style="margin-bottom: 24px; display: grid; gap: 16px;">
                    <div>
                        <input type="text" id="customFoodName" class="custom-food-header-input" required
                            placeholder="Food Name (e.g. My Smoothie)" style="width: 100%;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                        <div style="grid-column: span 1; display: flex; flex-direction: column;">
                            <input type="text" id="customBrand" class="custom-food-header-input" placeholder="Brand"
                                value="Homemade" style="font-size: 1em;">
                            <span style="font-size: 0.7em; color: #64748b; margin-top: 2px;">Brand</span>
                        </div>
                        <div style="display: flex; flex-direction: column;">
                            <input type="number" id="customServingSize" class="custom-food-header-input" required
                                step="any" min="0" placeholder="1" style="font-size: 1em;">
                            <span style="font-size: 0.7em; color: #64748b; margin-top: 2px;">Qty</span>
                        </div>
                        <div style="display: flex; flex-direction: column;">
                            <input type="text" id="customServingUnit" class="custom-food-header-input" required
                                placeholder="Unit" value="serving" style="font-size: 1em;">
                            <span style="font-size: 0.7em; color: #64748b; margin-top: 2px;">Unit</span>
                        </div>
                    </div>
                    <!-- Chips for Unit -->
                    <div class="chip-container">
                        <div id="lastUnitChip" class="chip"
                            style="display: none; border-color: #f59e0b; color: #fbbf24;"
                            onclick="handleChipClick(this.dataset.value)"></div>
                        <div class="chip" onclick="handleChipClick('100g')">100g</div>
                        <div class="chip" onclick="handleChipClick('oz')">oz</div>
                        <div class="chip" onclick="handleChipClick('cup')">cup</div>
                        <div class="chip" onclick="handleChipClick('piece')">piece</div>
                        <div class="chip" onclick="handleChipClick('serving')">serving</div>
                    </div>
                </div>

                <!-- STEP 1: Calories & Macros -->
                <div class="calories-hero">
                    <label>Calories</label>
                    <input type="number" id="customCalories" required min="0" step="1" placeholder="0">
                </div>

                <div class="macro-row" id="row-protein"
                    style="background: rgba(96, 165, 250, 0.15); border-color: rgba(96, 165, 250, 0.2);">
                    <label style="color: #60a5fa;">Protein</label>
                    <div class="macro-input-group">
                        <input type="number" id="customProtein" min="0" step="0.1" placeholder="0" class="macro-watch">
                        <span style="color: #64748b; font-size: 0.9em;">g</span>
                    </div>
                </div>

                <div class="macro-row" id="row-carbs"
                    style="background: rgba(192, 132, 252, 0.15); border-color: rgba(192, 132, 252, 0.2);">
                    <label style="color: #c084fc;">Carbs</label>
                    <div class="macro-input-group">
                        <input type="number" id="customCarbs" min="0" step="0.1" placeholder="0" class="macro-watch">
                        <span style="color: #64748b; font-size: 0.9em;">g</span>
                    </div>
                </div>

                <div class="macro-row" id="row-fat"
                    style="background: rgba(242, 198, 75, 0.15); border-color: rgba(242, 198, 75, 0.2);">
                    <label style="color: #f2c64b;">Fat</label>
                    <div class="macro-input-group">
                        <input type="number" id="customFat" min="0" step="0.1" placeholder="0" class="macro-watch">
                        <span style="color: #64748b; font-size: 0.9em;">g</span>
                    </div>
                </div>

                <!-- STEP 2: More Nutrition -->
                <div class="expand-section">
                    <div class="expand-header" onclick="toggleExpand('moreNutritionSection')">
                        <span>More Nutrition</span>
                        <span id="moreNutritionSectionArrow">‚ñº</span>
                    </div>
                    <div id="moreNutritionSection" class="expand-content">
                        <div class="mini-grid">
                            <div class="mini-input-group">
                                <label>Fiber (g)</label>
                                <input type="number" id="customFiber" step="0.1" placeholder="-">
                            </div>
                            <div class="mini-input-group">
                                <label>Sugar (g)</label>
                                <input type="number" id="customSugar" step="0.1" placeholder="-">
                            </div>
                            <div class="mini-input-group">
                                <label>Sodium (mg)</label>
                                <input type="number" id="customSodium" step="0.1" placeholder="-">
                            </div>
                        </div>

                        <!-- STEP 3: Advanced (Nested) -->
                        <div class="expand-section" style="border-top: 1px dashed #334155;">
                            <div class="expand-header" onclick="toggleExpand('advancedNutritionSection')">
                                <span>Advanced Nutrition</span>
                                <span id="advancedNutritionSectionArrow">‚ñº</span>
                            </div>
                            <div id="advancedNutritionSection" class="expand-content">
                                <!-- Fats: 2x2 Grid -->
                                <div
                                    style="margin-bottom: 12px; color: #64748b; font-size: 0.8em; text-transform: uppercase; letter-spacing: 0.5px;">
                                    Fat Breakdown</div>
                                <div
                                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                                    <div class="mini-input-group">
                                        <label>Saturated</label>
                                        <input type="number" id="customSatFat" step="0.1" placeholder="-">
                                    </div>
                                    <div class="mini-input-group">
                                        <label>Trans</label>
                                        <input type="number" id="customTransFat" step="0.1" placeholder="-">
                                    </div>
                                    <div class="mini-input-group">
                                        <label>Poly</label>
                                        <input type="number" id="customPolyFat" step="0.1" placeholder="-">
                                    </div>
                                    <div class="mini-input-group">
                                        <label>Mono</label>
                                        <input type="number" id="customMonoFat" step="0.1" placeholder="-">
                                    </div>
                                </div>

                                <!-- Other: 2 items -->
                                <div
                                    style="margin-bottom: 12px; color: #64748b; font-size: 0.8em; text-transform: uppercase; letter-spacing: 0.5px;">
                                    Other</div>
                                <div
                                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                                    <div class="mini-input-group">
                                        <label>Cholesterol (mg)</label>
                                        <input type="number" id="customCholesterol" step="0.1" placeholder="-">
                                    </div>
                                    <div class="mini-input-group">
                                        <label>Added Sugar (g)</label>
                                        <input type="number" id="customAddedSugar" step="0.1" placeholder="-">
                                    </div>
                                </div>

                                <!-- Micros: keep existing grid -->
                                <div
                                    style="margin-bottom: 12px; color: #64748b; font-size: 0.8em; text-transform: uppercase; letter-spacing: 0.5px;">
                                    Micros</div>
                                <div class="mini-grid">
                                    <div class="mini-input-group">
                                        <label>Calcium</label>
                                        <input type="number" id="customCalcium" step="0.1" placeholder="-">
                                    </div>
                                    <div class="mini-input-group">
                                        <label>Iron</label>
                                        <input type="number" id="customIron" step="0.1" placeholder="-">
                                    </div>
                                    <div class="mini-input-group">
                                        <label>Potassium</label>
                                        <input type="number" id="customPotassium" step="0.1" placeholder="-">
                                    </div>
                                    <div class="mini-input-group">
                                        <label>Vit C</label>
                                        <input type="number" id="customVitC" step="0.1" placeholder="-">
                                    </div>
                                    <div class="mini-input-group">
                                        <label>Vit D</label>
                                        <input type="number" id="customVitD" step="0.1" placeholder="-">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer" style="border-top: none; margin-top: 32px;">
                    <button type="submit" class="primary-btn">Save Food</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Meal Modal -->
    <div id="editModalOverlay" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Edit Meal</div>
                <button class="close-btn" onclick="closeEditModal()">&times;</button>
            </div>

            <div class="form-group">
                <label>Food Name</label>
                <input type="text" id="editFoodName">
            </div>

            <div class="form-group" id="editPortionSection">
                <div style="display: flex; gap: 10px;">
                    <div style="flex: 1;">
                        <label>Portion</label>
                        <input type="number" id="editPortionInput" step="any" min="0">
                    </div>
                    <div style="flex: 1;">
                        <label>Unit</label>
                        <input type="text" id="editUnitInput" disabled
                            style="background: rgba(15, 23, 42, 0.4); color: #94a3b8;">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>Nutrition</label>
                <div class="nutrition-grid">
                    <div class="nutrition-item">
                        <label>Calories</label>
                        <input type="number" id="editCalInput" min="0" step="1">
                    </div>
                    <div class="nutrition-item">
                        <label>Protein</label>
                        <input type="number" id="editProtInput" min="0" step="0.1">
                    </div>
                    <div class="nutrition-item">
                        <label>Carbs</label>
                        <input type="number" id="editCarbInput" min="0" step="0.1">
                    </div>
                    <div class="nutrition-item">
                        <label>Fat</label>
                        <input type="number" id="editFatInput" min="0" step="0.1">
                    </div>
                    <div class="nutrition-item">
                        <label>Cholesterol (mg)</label>
                        <input type="number" id="editCholesterolInput" min="0" step="0.1">
                    </div>
                    <div class="nutrition-item">
                        <label>Sodium (mg)</label>
                        <input type="number" id="editSodiumInput" min="0" step="0.1">
                    </div>
                    <div class="nutrition-item">
                        <label>Fiber (g)</label>
                        <input type="number" id="editFiberInput" min="0" step="0.1">
                    </div>
                    <div class="nutrition-item">
                        <label>Sugar (g)</label>
                        <input type="number" id="editSugarInput" min="0" step="0.1">
                    </div>
                    <div class="nutrition-item">
                        <label>Sat. Fat (g)</label>
                        <input type="number" id="editSaturatedFatInput" min="0" step="0.1">
                    </div>
                    <div class="nutrition-item">
                        <label>Trans Fat (g)</label>
                        <input type="number" id="editTransFatInput" min="0" step="0.1">
                    </div>
                    <div class="nutrition-item">
                        <label>Polyunsat. Fat (g)</label>
                        <input type="number" id="editPolyunsaturatedFatInput" min="0" step="0.1">
                    </div>
                    <div class="nutrition-item">
                        <label>Monounsat. Fat (g)</label>
                        <input type="number" id="editMonounsaturatedFatInput" min="0" step="0.1">
                    </div>
                    <div class="nutrition-item">
                        <label>Added Sugar (g)</label>
                        <input type="number" id="editAddedSugarInput" min="0" step="0.1">
                    </div>
                    <div class="nutrition-item">
                        <label>Vitamin D (mcg)</label>
                        <input type="number" id="editVitaminDInput" min="0" step="0.1">
                    </div>
                    <div class="nutrition-item">
                        <label>Calcium (mg)</label>
                        <input type="number" id="editCalciumInput" min="0" step="0.1">
                    </div>
                    <div class="nutrition-item">
                        <label>Iron (mg)</label>
                        <input type="number" id="editIronInput" min="0" step="0.1">
                    </div>
                    <div class="nutrition-item">
                        <label>Potassium (mg)</label>
                        <input type="number" id="editPotassiumInput" min="0" step="0.1">
                    </div>
                    <div class="nutrition-item">
                        <label>Vitamin C (mg)</label>
                        <input type="number" id="editVitaminCInput" min="0" step="0.1">
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button class="primary-btn" onclick="saveEditedMeal()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Add Event Type Modal -->
    <div id="addEventTypeModalOverlay" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Add Event Type</div>
                <button class="close-btn" onclick="closeAddEventTypeModal()">&times;</button>
            </div>

            <form id="addEventTypeForm" onsubmit="handleAddEventTypeSubmit(event)">
                <div class="form-group">
                    <label for="eventTypeName">Name *</label>
                    <input type="text" id="eventTypeName" placeholder="e.g., Morning Run" required>
                </div>

                <div class="form-group">
                    <label for="eventTypeCategory">Category *</label>
                    <select id="eventTypeCategory" required
                        style="width: 100%; padding: 12px; background: rgba(39, 39, 42, 0.6); border: 1px solid #3f3f46; border-radius: 8px; color: #e4e4e7; font-size: 1em;">
                        <option value="Nutrition">üçé Nutrition</option>
                        <option value="Fitness">üí™ Fitness</option>
                        <option value="Health">‚öñÔ∏è Health</option>
                        <option value="Custom">‚≠ê Custom</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="eventTypeIcon">Icon</label>
                    <input type="text" id="eventTypeIcon" placeholder="üìä" value="üìä" maxlength="2">
                </div>

                <div class="form-group">
                    <label for="eventTypeColor">Color</label>
                    <input type="color" id="eventTypeColor" value="#9C27B0"
                        style="width: 100%; height: 50px; padding: 4px; background: rgba(39, 39, 42, 0.6); border: 1px solid #3f3f46; border-radius: 8px; cursor: pointer;">
                </div>

                <div class="form-group">
                    <label>Primary Unit (Required)</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="eventTypePrimaryLabel" placeholder="Label (e.g. Distance)" required
                            style="flex: 1">
                        <input type="text" id="eventTypePrimaryUnit" placeholder="Unit (e.g. km)" required
                            style="flex: 1">
                    </div>
                </div>

                <div id="additionalUnitsContainer">
                    <!-- Dynamic units go here -->
                </div>

                <button type="button" class="btn-secondary" onclick="addAdditionalUnitField()"
                    style="width: 100%; margin-bottom: 20px; border-style: dashed;">+ Add Another Unit</button>

                <div class="form-group">
                    <label for="eventTypeAggregation">Aggregation Type</label>
                    <select id="eventTypeAggregation"
                        style="width: 100%; padding: 12px; background: rgba(39, 39, 42, 0.6); border: 1px solid #3f3f46; border-radius: 8px; color: #e4e4e7; font-size: 1em;">
                        <option value="sum_today">Sum Today (Daily Total)</option>
                        <option value="sum">Sum (Lifetime Total)</option>
                        <option value="last">Last Value</option>
                        <option value="average">Average</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="eventTypeTracking">Tracking Type</label>
                    <select id="eventTypeTracking"
                        style="width: 100%; padding: 12px; background: rgba(39, 39, 42, 0.6); border: 1px solid #3f3f46; border-radius: 8px; color: #e4e4e7; font-size: 1em;">
                        <option value="number">Number (Input Box)</option>
                        <option value="count">Count (Plus Button)</option>
                        <option value="rating">Rating (5 Stars)</option>
                    </select>
                </div>

                <div class="modal-footer"
                    style="display: flex; justify-content: flex-end; gap: 12px; align-items: center;">
                    <button type="button" id="deleteEventTypeBtn" class="meal-delete hidden"
                        onclick="handleDeleteEventType()"
                        style="margin-right: auto; padding: 10px 16px;">Delete</button>
                    <button type="button" class="btn-secondary" onclick="closeAddEventTypeModal()">Cancel</button>
                    <button type="submit" class="primary-btn">Create Event Type</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/storage.js"></script>
    <script>
        // ===== PAGE NAVIGATION =====
        async function forceUpdate() {
            if (confirm('This will update the app to the latest version. This involves clearing the cache and reloading. Continue?')) {
                try {
                    // 1. Unregister Service Worker
                    if ('serviceWorker' in navigator) {
                        const registrations = await navigator.serviceWorker.getRegistrations();
                        for (const registration of registrations) {
                            await registration.unregister();
                        }
                    }

                    // 2. Clear Caches
                    if ('caches' in window) {
                        const keys = await caches.keys();
                        await Promise.all(
                            keys.map(key => caches.delete(key))
                        );
                    }
                } catch (error) {
                    console.error('Error during update:', error);
                    alert('Error clearing cache. The page will reload anyway.');
                } finally {
                    // 3. Reload Window
                    window.location.reload(true);
                }
            }
        }

        function switchPage(pageNumber) {
            // Hide all pages
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.remove('active');
            });

            // Show selected page
            const selectedPage = document.getElementById(`page${pageNumber}`);
            if (selectedPage) {
                selectedPage.classList.add('active');
            }

            // Update tab bar active state
            document.querySelectorAll('.tab-item').forEach((tab, index) => {
                tab.classList.remove('active');

                // Map active pages to tabs
                // Stats (0) -> Page 1, Page 3 (Food), Page 6 (Events)
                // Goals (1) -> Page 2
                // Home (2) -> Page 7
                // Activity (3) -> Page 4
                // Settings (4) -> Page 5

                let isActive = false;

                if (index === 0 && (pageNumber === 1 || pageNumber === 3 || pageNumber === 6)) isActive = true;
                if (index === 1 && pageNumber === 2) isActive = true;
                if (index === 2 && pageNumber === 7) isActive = true;
                if (index === 3 && pageNumber === 4) isActive = true;
                if (index === 4 && pageNumber === 5) isActive = true;

                if (isActive) {
                    tab.classList.add('active');
                }
            });

            // Update URL hash
            window.location.hash = `page${pageNumber}`;

            // Scroll to top
            window.scrollTo(0, 0);

            // Page Hooks
            if (pageNumber === 4) {
                loadProfilePage();
            } else if (pageNumber === 2) {
                // Load goals data if needed, or already handled by tab switching inside page
                initGoalsTab();
            } else if (pageNumber === 7) {
                // Refresh home favorites just in case
                if (typeof renderHomeFavorites === 'function') {
                    renderHomeFavorites();
                }
            }
        }

        // Restore page from URL hash on load
        window.addEventListener('DOMContentLoaded', () => {
            const hash = window.location.hash;
            if (hash && hash.startsWith('#page')) {
                const pageNumber = parseInt(hash.replace('#page', ''));
                if (pageNumber >= 1 && pageNumber <= 5) {
                    switchPage(pageNumber);
                }
            }

            // Load event types for favorites on startup (Home is default page)
            const userId = localStorage.getItem('lifestats_userId');
            if (userId) {
                loadEventTypes(userId).then(() => {
                    renderHomeFavorites();
                });
            }
        });

        // Handle browser back/forward buttons
        window.addEventListener('hashchange', () => {
            const hash = window.location.hash;
            if (hash && hash.startsWith('#page')) {
                const pageNumber = parseInt(hash.replace('#page', ''));
                if (pageNumber >= 1 && pageNumber <= 5) {
                    switchPage(pageNumber);
                }
            }
        });

        // ===== FOOD LOGGING LOGIC =====
        // Meal type emoji mapping
        const mealEmojis = {
            breakfast: 'üåÖ',
            lunch: 'üåû',
            dinner: 'üåô',
            snack: 'üçø'
        };

        // DOM Elements
        const searchInput = document.getElementById('foodSearch');
        const searchResults = document.getElementById('searchResults');
        const foodNameInput = document.getElementById('foodName');
        const nutritionInputs = document.getElementById('nutritionInputs');
        const toggleNutritionBtn = document.getElementById('toggleNutrition');
        const mealTypeInput = document.getElementById('mealType');
        const mealTypeBtns = document.querySelectorAll('.meal-type-btn');

        // Meal Type Selection Logic
        mealTypeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                // Update hidden input
                const value = btn.dataset.value;
                mealTypeInput.value = value;

                // Update visual state
                mealTypeBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            });
        });

        // Nutrition inputs
        const calInput = document.getElementById('calInput');
        const protInput = document.getElementById('protInput');
        const carbInput = document.getElementById('carbInput');
        const fatInput = document.getElementById('fatInput');

        // Display user ID
        // Display user ID
        const userIdDisplay = document.getElementById('userIdDisplay');
        const userIdText = userIdDisplay.children[1]; // The monospace div
        userIdText.textContent = storage.userId;

        // Edit User ID
        userIdDisplay.addEventListener('click', () => {
            const newId = prompt('Enter your User ID (or "Link Device" code):', storage.userId);
            if (newId && newId.trim() !== '' && newId !== storage.userId) {
                if (confirm(`Switch User ID to "${newId}"? This will reload the app.`)) {
                    localStorage.setItem('lifestats_userId', newId.trim());
                    location.reload();
                }
            }
        });

        // Toggle Nutrition Visibility
        toggleNutritionBtn.addEventListener('click', () => {
            nutritionInputs.classList.toggle('hidden');
            const isHidden = nutritionInputs.classList.contains('hidden');
            toggleNutritionBtn.textContent = isHidden ? '(Show)' : '(Hide)';
        });

        // Portion Scaling
        const portionInput = document.getElementById('portionInput');

        portionInput.addEventListener('input', (e) => {
            if (!window.refNutrition) return;

            const newPortion = parseFloat(e.target.value);
            if (isNaN(newPortion) || newPortion < 0) return;

            const ratio = newPortion / window.refNutrition.portion;

            calInput.value = Math.round(window.refNutrition.calories * ratio);
            protInput.value = Number((window.refNutrition.protein * ratio).toFixed(1));
            carbInput.value = Number((window.refNutrition.carbs * ratio).toFixed(1));
            fatInput.value = Number((window.refNutrition.fat * ratio).toFixed(1));
        });

        // Search Debounce
        let searchTimeout;
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();

            if (query.length < 2) {
                searchResults.style.display = 'none';
                return;
            }

            // 1. Instant Local Search
            performSearch(query, true);

            // 2. Debounced Full Search (API)
            searchTimeout = setTimeout(() => performSearch(query, false), 500);
        });

        // Perform Search
        async function performSearch(query, localOnly = false) {
            try {
                let url = `/api/search-food?q=${encodeURIComponent(query)}`;
                if (localOnly) url += '&local_only=true';

                const response = await fetch(url);
                const data = await response.json();

                if (data.foods && data.foods.length > 0) {
                    renderSearchResults(data.foods);
                } else if (!localOnly) {
                    // Only show "no results" on full search
                    searchResults.innerHTML = '<div class="search-result-item">No results found</div>';
                    searchResults.style.display = 'block';
                }
            } catch (err) {
                console.error('Search error:', err);
            }
        }

        // Render Search Results
        function renderSearchResults(foods) {
            searchResults.innerHTML = foods.map(food => {
                const brand = food.brandName ? `‚Ä¢ ${food.brandName}` : '';

                // Calculate display calories
                let calText = '';
                if (food.preCalculated) {
                    calText = `${food.calories} kcal (${food.servingSize} ${food.servingUnit})`;
                } else if (food.servingSize && food.calories) {
                    const calsPerServing = Math.round((food.calories / 100) * food.servingSize);
                    calText = `${calsPerServing} kcal (${food.servingSize}${food.servingUnit || 'g'})`;
                } else if (food.calories) {
                    calText = `${food.calories} kcal (per 100g)`;
                }

                return `
                    <div class="search-result-item" onclick='selectFood(${JSON.stringify(food).replace(/'/g, "&#39;")})'>
                        <div class="search-result-name">${escapeHtml(food.description)}</div>
                        <div class="search-result-details">${calText} ${brand}</div>
                    </div>
                `;
            }).join('');
            searchResults.style.display = 'block';
        }

        // SelectFood
        async function selectFood(food) {
            // Fetch detailed data if possible
            if (food.fdcId) {
                document.body.style.cursor = 'wait';
                try {
                    const resp = await fetch(`/api/get-food-details?food_id=${food.fdcId}`);
                    if (resp.ok) {
                        const detailed = await resp.json();
                        // Use detailed data
                        food = detailed;
                    }
                } catch (e) {
                    console.error("Failed to fetch food details", e);
                } finally {
                    document.body.style.cursor = 'default';
                }
            }

            foodNameInput.value = food.description;

            // Calculate nutrition per serving if available
            let multiplier = 1; // Default to 100g values

            if (food.preCalculated) {
                multiplier = 1;
            } else if (food.servingSize) {
                multiplier = food.servingSize / 100;
            }

            // Auto-fill nutrition (per serving or per 100g)
            const baseCals = Math.round((food.calories || 0) * multiplier);
            const baseProt = Number(((food.protein || 0) * multiplier).toFixed(1));
            const baseCarb = Number(((food.carbs || 0) * multiplier).toFixed(1));
            const baseFat = Number(((food.fat || 0) * multiplier).toFixed(1));

            calInput.value = baseCals;
            protInput.value = baseProt;
            carbInput.value = baseCarb;
            fatInput.value = baseFat;

            // Setup Portion Control
            const portionSection = document.getElementById('portionSection');
            const portionInput = document.getElementById('portionInput');
            const unitInput = document.getElementById('unitInput');

            // Use the parsed serving size from backend
            const displayPortion = food.servingSize || 1;

            portionInput.value = displayPortion;
            unitInput.value = food.servingUnit || '';
            portionSection.classList.remove('hidden');

            // Store reference values for scaling
            window.refNutrition = {
                calories: baseCals,
                protein: baseProt,
                carbs: baseCarb,
                fat: baseFat,
                cholesterol: food.cholesterol,
                sodium: food.sodium,
                fiber: food.fiber,
                sugar: food.sugar,
                saturatedFat: food.saturatedFat,
                transFat: food.transFat,
                polyunsaturatedFat: food.polyunsaturatedFat,
                monounsaturatedFat: food.monounsaturatedFat,
                addedSugar: food.addedSugar,
                vitaminD: food.vitaminD,
                calcium: food.calcium,
                iron: food.iron,
                potassium: food.potassium,
                vitaminC: food.vitaminC,
                portion: displayPortion
            };

            // Show nutrition section
            nutritionInputs.classList.remove('hidden');
            toggleNutritionBtn.textContent = '(Hide)';

            // Clear search
            searchInput.value = '';
            searchResults.style.display = 'none';
        }



        // Close search when clicking outside
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.style.display = 'none';
            }
        });

        // Handle form submission
        // Edit Modal Logic
        const editModalOverlay = document.getElementById('editModalOverlay');
        let currentEditingMeal = null;
        let originalEditingMeal = null;

        function closeEditModal() {
            editModalOverlay.classList.add('hidden');
            currentEditingMeal = null;
            originalEditingMeal = null;
        }

        window.openMealDetail = function (meal) {
            currentEditingMeal = JSON.parse(JSON.stringify(meal)); // Deep copy
            originalEditingMeal = meal;

            // Populate fields
            document.getElementById('editFoodName').value = meal.foodName;

            document.getElementById('editCalInput').value = meal.nutrition.calories;
            document.getElementById('editProtInput').value = meal.nutrition.protein;
            document.getElementById('editCarbInput').value = meal.nutrition.carbs;
            document.getElementById('editFatInput').value = meal.nutrition.fat;
            document.getElementById('editCholesterolInput').value = meal.nutrition.cholesterol !== null ? meal.nutrition.cholesterol : '';
            document.getElementById('editSodiumInput').value = meal.nutrition.sodium !== null ? meal.nutrition.sodium : '';
            document.getElementById('editFiberInput').value = meal.nutrition.fiber !== null ? meal.nutrition.fiber : '';
            document.getElementById('editSugarInput').value = meal.nutrition.sugar !== null ? meal.nutrition.sugar : '';
            document.getElementById('editSaturatedFatInput').value = meal.nutrition.saturatedFat !== null ? meal.nutrition.saturatedFat : '';
            document.getElementById('editTransFatInput').value = meal.nutrition.transFat !== null ? meal.nutrition.transFat : '';
            document.getElementById('editPolyunsaturatedFatInput').value = meal.nutrition.polyunsaturatedFat !== null ? meal.nutrition.polyunsaturatedFat : '';
            document.getElementById('editMonounsaturatedFatInput').value = meal.nutrition.monounsaturatedFat !== null ? meal.nutrition.monounsaturatedFat : '';
            document.getElementById('editAddedSugarInput').value = meal.nutrition.addedSugar !== null ? meal.nutrition.addedSugar : '';
            document.getElementById('editVitaminDInput').value = meal.nutrition.vitaminD !== null ? meal.nutrition.vitaminD : '';
            document.getElementById('editCalciumInput').value = meal.nutrition.calcium !== null ? meal.nutrition.calcium : '';
            document.getElementById('editIronInput').value = meal.nutrition.iron !== null ? meal.nutrition.iron : '';
            document.getElementById('editPotassiumInput').value = meal.nutrition.potassium !== null ? meal.nutrition.potassium : '';
            document.getElementById('editVitaminCInput').value = meal.nutrition.vitaminC !== null ? meal.nutrition.vitaminC : '';

            // Handle Portion
            const editPortionSection = document.getElementById('editPortionSection');
            const editPortionInput = document.getElementById('editPortionInput');
            const editUnitInput = document.getElementById('editUnitInput');

            // Always show portion section if servingSize exists (it defaults to 1.0)
            if (meal.servingSize) {
                editPortionSection.classList.remove('hidden');
                editPortionInput.value = meal.servingSize;
                editUnitInput.value = meal.servingUnit || 'serving'; // Default to 'serving' if empty
            } else {
                // Fallback for very old data if any
                editPortionSection.classList.remove('hidden');
                editPortionInput.value = 1;
                editUnitInput.value = 'serving';
                // Ensure we have a base for scaling
                originalEditingMeal.servingSize = 1;
            }

            editModalOverlay.classList.remove('hidden');
        };

        // Scale Logic for Edit Modal
        document.getElementById('editPortionInput').addEventListener('input', (e) => {
            if (!currentEditingMeal || !originalEditingMeal.servingSize) return;

            const newPortion = parseFloat(e.target.value);
            if (isNaN(newPortion) || newPortion < 0) return;

            const ratio = newPortion / originalEditingMeal.servingSize;

            document.getElementById('editCalInput').value = Math.round(originalEditingMeal.nutrition.calories * ratio);
            document.getElementById('editProtInput').value = Number((originalEditingMeal.nutrition.protein * ratio).toFixed(1));
            document.getElementById('editCarbInput').value = Number((originalEditingMeal.nutrition.carbs * ratio).toFixed(1));
            document.getElementById('editFatInput').value = Number((originalEditingMeal.nutrition.fat * ratio).toFixed(1));
            document.getElementById('editCholesterolInput').value = originalEditingMeal.nutrition.cholesterol !== null ? Number((originalEditingMeal.nutrition.cholesterol * ratio).toFixed(1)) : '';
            document.getElementById('editSodiumInput').value = originalEditingMeal.nutrition.sodium !== null ? Number((originalEditingMeal.nutrition.sodium * ratio).toFixed(1)) : '';
            document.getElementById('editFiberInput').value = originalEditingMeal.nutrition.fiber !== null ? Number((originalEditingMeal.nutrition.fiber * ratio).toFixed(1)) : '';
            document.getElementById('editSugarInput').value = originalEditingMeal.nutrition.sugar !== null ? Number((originalEditingMeal.nutrition.sugar * ratio).toFixed(1)) : '';
            document.getElementById('editSaturatedFatInput').value = originalEditingMeal.nutrition.saturatedFat !== null ? Number((originalEditingMeal.nutrition.saturatedFat * ratio).toFixed(1)) : '';
            document.getElementById('editTransFatInput').value = originalEditingMeal.nutrition.transFat !== null ? Number((originalEditingMeal.nutrition.transFat * ratio).toFixed(1)) : '';
            document.getElementById('editPolyunsaturatedFatInput').value = originalEditingMeal.nutrition.polyunsaturatedFat !== null ? Number((originalEditingMeal.nutrition.polyunsaturatedFat * ratio).toFixed(1)) : '';
            document.getElementById('editMonounsaturatedFatInput').value = originalEditingMeal.nutrition.monounsaturatedFat !== null ? Number((originalEditingMeal.nutrition.monounsaturatedFat * ratio).toFixed(1)) : '';
            document.getElementById('editAddedSugarInput').value = originalEditingMeal.nutrition.addedSugar !== null ? Number((originalEditingMeal.nutrition.addedSugar * ratio).toFixed(1)) : '';
            document.getElementById('editVitaminDInput').value = originalEditingMeal.nutrition.vitaminD !== null ? Number((originalEditingMeal.nutrition.vitaminD * ratio).toFixed(1)) : '';
            document.getElementById('editCalciumInput').value = originalEditingMeal.nutrition.calcium !== null ? Number((originalEditingMeal.nutrition.calcium * ratio).toFixed(1)) : '';
            document.getElementById('editIronInput').value = originalEditingMeal.nutrition.iron !== null ? Number((originalEditingMeal.nutrition.iron * ratio).toFixed(1)) : '';
            document.getElementById('editPotassiumInput').value = originalEditingMeal.nutrition.potassium !== null ? Number((originalEditingMeal.nutrition.potassium * ratio).toFixed(1)) : '';
            document.getElementById('editVitaminCInput').value = originalEditingMeal.nutrition.vitaminC !== null ? Number((originalEditingMeal.nutrition.vitaminC * ratio).toFixed(1)) : '';
        });

        window.saveEditedMeal = async function () {
            if (!currentEditingMeal) return;

            const updates = {
                foodName: document.getElementById('editFoodName').value,
                nutrition: {
                    calories: Number(document.getElementById('editCalInput').value),
                    protein: Number(document.getElementById('editProtInput').value),
                    carbs: Number(document.getElementById('editCarbInput').value),
                    fat: Number(document.getElementById('editFatInput').value),
                    cholesterol: document.getElementById('editCholesterolInput').value ? Number(document.getElementById('editCholesterolInput').value) : null,
                    sodium: document.getElementById('editSodiumInput').value ? Number(document.getElementById('editSodiumInput').value) : null,
                    fiber: document.getElementById('editFiberInput').value ? Number(document.getElementById('editFiberInput').value) : null,
                    sugar: document.getElementById('editSugarInput').value ? Number(document.getElementById('editSugarInput').value) : null,
                    saturatedFat: document.getElementById('editSaturatedFatInput').value ? Number(document.getElementById('editSaturatedFatInput').value) : null,
                    transFat: document.getElementById('editTransFatInput').value ? Number(document.getElementById('editTransFatInput').value) : null,
                    polyunsaturatedFat: document.getElementById('editPolyunsaturatedFatInput').value ? Number(document.getElementById('editPolyunsaturatedFatInput').value) : null,
                    monounsaturatedFat: document.getElementById('editMonounsaturatedFatInput').value ? Number(document.getElementById('editMonounsaturatedFatInput').value) : null,
                    addedSugar: document.getElementById('editAddedSugarInput').value ? Number(document.getElementById('editAddedSugarInput').value) : null,
                    vitaminD: document.getElementById('editVitaminDInput').value ? Number(document.getElementById('editVitaminDInput').value) : null,
                    calcium: document.getElementById('editCalciumInput').value ? Number(document.getElementById('editCalciumInput').value) : null,
                    iron: document.getElementById('editIronInput').value ? Number(document.getElementById('editIronInput').value) : null,
                    potassium: document.getElementById('editPotassiumInput').value ? Number(document.getElementById('editPotassiumInput').value) : null,
                    vitaminC: document.getElementById('editVitaminCInput').value ? Number(document.getElementById('editVitaminCInput').value) : null
                }
            };

            const newPortion = parseFloat(document.getElementById('editPortionInput').value);
            if (!isNaN(newPortion) && !document.getElementById('editPortionSection').classList.contains('hidden')) {
                updates.servingSize = newPortion;
                updates.servingUnit = document.getElementById('editUnitInput').value;
            }

            const success = await storage.updateMeal(currentEditingMeal.id, updates);
            if (success) {
                closeEditModal();
                await renderMeals();
            } else {
                alert('Failed to save changes');
            }
        };

        // Close on outside click
        editModalOverlay.addEventListener('click', (e) => {
            if (e.target === editModalOverlay) closeEditModal();
        });


        document.getElementById('foodForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const foodName = foodNameInput.value.trim();
            const mealType = mealTypeInput.value;

            // Collect serving info first to calculate ratio
            const portionVal = parseFloat(document.getElementById('portionInput').value);
            const refPortion = window.refNutrition?.portion || 1;
            const ratio = (portionVal && refPortion) ? (portionVal / refPortion) : 1;

            // Helper to scale values
            const scale = (val) => (val !== null && val !== undefined) ? Number((val * ratio).toFixed(1)) : null;

            // Collect nutrition data
            const nutrition = {
                calories: Number(calInput.value) || 0,
                protein: Number(protInput.value) || 0,
                carbs: Number(carbInput.value) || 0,
                fat: Number(fatInput.value) || 0,
                cholesterol: scale(window.refNutrition?.cholesterol),
                sodium: scale(window.refNutrition?.sodium),
                fiber: scale(window.refNutrition?.fiber),
                sugar: scale(window.refNutrition?.sugar),
                saturatedFat: scale(window.refNutrition?.saturatedFat),
                transFat: scale(window.refNutrition?.transFat),
                polyunsaturatedFat: scale(window.refNutrition?.polyunsaturatedFat),
                monounsaturatedFat: scale(window.refNutrition?.monounsaturatedFat),
                addedSugar: scale(window.refNutrition?.addedSugar),
                vitaminD: scale(window.refNutrition?.vitaminD),
                calcium: scale(window.refNutrition?.calcium),
                iron: scale(window.refNutrition?.iron),
                potassium: scale(window.refNutrition?.potassium),
                vitaminC: scale(window.refNutrition?.vitaminC)
            };

            if (foodName) {
                // Collect serving info
                const portionVal = parseFloat(document.getElementById('portionInput').value);
                const unitVal = document.getElementById('unitInput').value;

                const servingInfo = {
                    size: !isNaN(portionVal) ? portionVal : 1.0,
                    unit: unitVal || 'serving'
                };

                // Save meal
                await storage.saveMeal(foodName, mealType, nutrition, servingInfo);

                // Success feedback
                const form = document.getElementById('foodForm');
                form.classList.add('success-feedback');
                setTimeout(() => form.classList.remove('success-feedback'), 500);

                // Clear form
                foodNameInput.value = '';
                searchInput.value = '';
                calInput.value = '';
                protInput.value = '';
                carbInput.value = '';
                fatInput.value = '';
                fatInput.value = '';

                // Reset Portion Section
                document.getElementById('portionSection').classList.add('hidden');
                document.getElementById('portionInput').value = '';
                document.getElementById('unitInput').value = '';
                window.refNutrition = null;

                nutritionInputs.classList.add('hidden');
                toggleNutritionBtn.textContent = '(Show)';

                // Refresh list
                await renderMeals();

                if (navigator.vibrate) navigator.vibrate(50);
            }
        });

        // Render meals list
        async function renderMeals() {
            const mealsList = document.getElementById('mealsList');
            const todaysMeals = await storage.getTodaysMeals();

            // Calculate total calories
            const totalCalories = todaysMeals.reduce((sum, meal) => sum + (meal.nutrition?.calories || 0), 0);
            document.getElementById('dailyTotal').textContent = `${totalCalories} kcal`;

            if (todaysMeals.length === 0) {
                mealsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-emoji">üçΩÔ∏è</div>
                        <div>No meals logged today</div>
                    </div>
                `;
                return;
            }

            // Sort by timestamp (most recent first)
            todaysMeals.sort((a, b) => b.timestamp - a.timestamp);

            mealsList.innerHTML = todaysMeals.map(meal => {
                const time = new Date(meal.timestamp).toLocaleTimeString([], {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const cals = meal.nutrition?.calories ? `${meal.nutrition.calories} kcal` : '';
                const macros = [];
                if (meal.nutrition?.protein) macros.push(`${meal.nutrition.protein}p`);
                if (meal.nutrition?.carbs) macros.push(`${meal.nutrition.carbs}c`);
                if (meal.nutrition?.fat) macros.push(`${meal.nutrition.fat}f`);
                const macroStr = macros.length > 0 ? `‚Ä¢ ${macros.join(' ')}` : '';

                return `
                    <div class="meal-item" onclick='openMealDetail(${JSON.stringify(meal).replace(/'/g, "&#39;")})' style="cursor: pointer;">
                        <div class="meal-emoji">${mealEmojis[meal.mealType]}</div>
                        <div class="meal-info">
                            <div class="meal-name">${escapeHtml(meal.foodName)}</div>
                            <div class="meal-time">${meal.mealType} ‚Ä¢ ${time}</div>
                            ${cals ? `<div class="meal-macros">${cals} ${macroStr}</div>` : ''}
                        </div>
                        <button class="meal-delete" onclick="event.stopPropagation(); deleteMeal('${meal.id}')">Delete</button>
                    </div>
                `;
            }).join('');
        }

        // Delete meal
        async function deleteMeal(mealId) {
            if (confirm('Delete this meal?')) {
                await storage.deleteMeal(mealId);
                await renderMeals();
            }
        }

        // Helper: Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Notification Helper
        function showNotification(message, duration = 3000) {
            const toast = document.getElementById('notificationToast');
            const msgEl = document.getElementById('notificationMessage');
            msgEl.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        // Initial render
        renderMeals();

        // Custom Food Modal Logic
        const customFoodModal = document.getElementById('customFoodModalOverlay');
        const customFoodForm = document.getElementById('customFoodForm');
        const expansionOverlay = document.getElementById('expansion-overlay');

        // Store source button rect for closing animation
        let sourceButtonRect = null;

        function openCustomFoodModal(btnElement) {
            // 1. Get position of button (Start State)
            // Fix: Target the inner green square div, not the container (which includes text and is rectangular)
            const actualBtn = btnElement ? btnElement.querySelector('div') : null;
            const btnRect = actualBtn ? actualBtn.getBoundingClientRect() : { top: window.innerHeight / 2, left: window.innerWidth / 2, width: 0, height: 0 };
            sourceButtonRect = btnRect; // Store for close animation

            // 2. Setup Overlay at Start Position
            expansionOverlay.style.transition = 'none';
            expansionOverlay.style.width = btnRect.width + 'px';
            expansionOverlay.style.height = btnRect.height + 'px';
            expansionOverlay.style.left = btnRect.left + 'px';
            expansionOverlay.style.top = btnRect.top + 'px';
            expansionOverlay.style.borderRadius = '10px'; // Button radius
            expansionOverlay.style.opacity = '1';

            // 3. Force reflow
            expansionOverlay.offsetHeight;

            // 4. Measure Actual Target Size
            // We need to show the modal (but invisible) to measure it
            // Prepare overlay for fade-in: unhide, but opacity 0
            customFoodModal.style.transition = 'none';
            customFoodModal.style.opacity = '0';
            customFoodModal.classList.remove('hidden');

            // Hide the inner modal content initially so it doesn't pop in before animation ends
            const modalEl = customFoodModal.querySelector('.modal');
            modalEl.style.opacity = '0';

            // Measure
            const targetRect = modalEl.getBoundingClientRect();

            // 5. Start Animations

            // A. Fade in Background Overlay (Blur)
            // Force reflow for overlay transition
            customFoodModal.offsetHeight;
            customFoodModal.style.transition = 'all 0.4s ease';
            customFoodModal.style.opacity = '1';

            // B. Animate Expansion Overlay to Target
            // Use the measured dimensions directly
            expansionOverlay.style.transition = 'all 0.35s cubic-bezier(0.2, 0.8, 0.2, 1)';
            expansionOverlay.style.width = targetRect.width + 'px';
            expansionOverlay.style.height = targetRect.height + 'px';
            expansionOverlay.style.left = targetRect.left + 'px';
            expansionOverlay.style.top = targetRect.top + 'px';
            expansionOverlay.style.borderRadius = '16px'; // Modal radius matches CSS

            // 6. Show Modal Content after animation
            setTimeout(() => {
                // Show inner modal
                modalEl.style.transition = 'opacity 0.1s ease';
                modalEl.style.opacity = '1';

                // Fade out green expansion overlay to reveal modal
                expansionOverlay.style.transition = 'opacity 0.2s ease';
                expansionOverlay.style.opacity = '0';
            }, 200);

            // Load Last Used Unit
            const lastUnit = localStorage.getItem('lifestats_last_custom_unit');
            const chip = document.getElementById('lastUnitChip');
            if (lastUnit) {
                chip.textContent = lastUnit;
                chip.dataset.value = lastUnit;
                chip.style.display = 'block';
            } else {
                chip.style.display = 'none';
            }
        }

        let manualCalorieEntry = false;

        function closeCustomFoodModal() {
            // Reverse Animation
            const modalEl = customFoodModal.querySelector('.modal');
            const currentRect = modalEl.getBoundingClientRect();

            // 1. Prepare Overlay at current modal position
            expansionOverlay.style.transition = 'none';
            expansionOverlay.style.width = currentRect.width + 'px';
            expansionOverlay.style.height = currentRect.height + 'px';
            expansionOverlay.style.left = currentRect.left + 'px';
            expansionOverlay.style.top = currentRect.top + 'px';
            expansionOverlay.style.borderRadius = '16px';
            expansionOverlay.style.opacity = '1'; // Make it visible again

            // 2. Hide Modal Content Immediately (fade out ideally, but snap for responsiveness)
            modalEl.style.opacity = '0';

            // 3. Force Reflow
            expansionOverlay.offsetHeight;

            // 4. Animate Back to Source
            const targetRect = sourceButtonRect || { top: window.innerHeight / 2, left: window.innerWidth / 2, width: 0, height: 0 };

            expansionOverlay.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)'; // Slightly faster close
            expansionOverlay.style.width = targetRect.width + 'px';
            expansionOverlay.style.height = targetRect.height + 'px';
            expansionOverlay.style.left = targetRect.left + 'px';
            expansionOverlay.style.top = targetRect.top + 'px';
            expansionOverlay.style.borderRadius = '10px';

            // 5. Fade Out Background Blur Concurrently
            customFoodModal.style.transition = 'opacity 0.3s ease';
            customFoodModal.style.opacity = '0';

            // 6. Cleanup after animation
            setTimeout(() => {
                customFoodModal.classList.add('hidden');
                customFoodForm.reset();
                expansionOverlay.style.opacity = '0';

                manualCalorieEntry = false; // Reset manual flag
                // Reset sections
                document.getElementById('moreNutritionSection').classList.remove('open');
                document.getElementById('moreNutritionSectionArrow').textContent = '‚ñº';
                document.getElementById('advancedNutritionSection').classList.remove('open');
                document.getElementById('advancedNutritionSectionArrow').textContent = '‚ñº';
            }, 300);
        }

        function toggleExpand(elementId) {
            const content = document.getElementById(elementId);
            const arrow = document.getElementById(elementId + 'Arrow');
            content.classList.toggle('open');
            arrow.textContent = content.classList.contains('open') ? '‚ñ≤' : '‚ñº';
        }

        // --- Smart Serving Unit Logic ---

        // Normalization Map
        const UNIT_MAP = {
            'g': 'g', 'gram': 'g', 'grams': 'g',
            'oz': 'oz', 'ounce': 'oz', 'ounces': 'oz',
            'cup': 'cup', 'cups': 'cup',
            'serving': 'serving', 'srv': 'serving',
            'piece': 'piece', 'pieces': 'piece'
        };

        function parseServingUnitInput(unitText, currentQty) {
            unitText = unitText.trim();
            if (!unitText) {
                return { qty: currentQty, unit: 'serving', status: 'normalized' };
            }

            // Regex to split optional number and text
            // Matches: start, optional float/int, spaces, rest string
            const match = unitText.match(/^([0-9]*\.?[0-9]+)?\s*(.*)$/);

            if (match) {
                const numStr = match[1];
                let textStr = match[2].toLowerCase().trim();

                let newQty = currentQty;
                let newUnit = textStr;

                // If number found in string, override qty
                if (numStr) {
                    newQty = parseFloat(numStr);
                    // Special case: if text is empty but number exists, use default 'serving' or keep current?
                    // Spec says: "100 g" -> qty=100, unit="g". "100" -> qty=100, unit=""?
                    // Let's assume if no text, default to 'serving' or 'piece'? 
                    // Better: if no text, keep textStr empty, handled by map fallback or raw
                    if (!textStr) textStr = 'serving';
                }

                // Normalize unit
                if (UNIT_MAP[textStr]) {
                    newUnit = UNIT_MAP[textStr];
                    return { qty: newQty, unit: newUnit, status: 'normalized' };
                }
                // else return raw
                return { qty: newQty, unit: textStr || 'serving', status: 'raw' };
            }

            return { qty: currentQty, unit: unitText, status: 'raw' };
        }

        function handleChipClick(chipText) {
            const qtyInput = document.getElementById('customServingSize');
            const unitInput = document.getElementById('customServingUnit');

            if (chipText === '100g') {
                qtyInput.value = 100;
                unitInput.value = 'g';
                qtyInput.focus();
            } else {
                qtyInput.value = 1;
                unitInput.value = chipText;
                unitInput.focus();
            }
        }

        // Blur Handler for Unit Input
        document.getElementById('customServingUnit').addEventListener('blur', (e) => {
            const unitVal = e.target.value;
            const qtyInput = document.getElementById('customServingSize');
            const currentQty = parseFloat(qtyInput.value) || 1; // Default to 1 if empty/invalid

            const result = parseServingUnitInput(unitVal, currentQty);

            if (result.status === 'normalized') {
                qtyInput.value = result.qty;
                e.target.value = result.unit;
            }
            // If raw, leave as is (as per requirement)
        });

        // Auto-calc logic
        const macroInputs = document.querySelectorAll('.macro-watch');
        macroInputs.forEach(input => {
            input.addEventListener('input', calculateCaloriesFromMacros);
        });

        // Detect manual calorie entry
        document.getElementById('customCalories').addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            if (!isNaN(val) && val > 0) {
                manualCalorieEntry = true;
            } else {
                manualCalorieEntry = false; // Reset if cleared or 0
                // Optional: Recalculate immediately if they clear it?
                // logic: if they clear it, they might want autofill back immediately. 
                // Let's trigger it.
                calculateCaloriesFromMacros();
            }
        });

        function calculateCaloriesFromMacros() {
            if (manualCalorieEntry) return;

            const p = parseFloat(document.getElementById('customProtein').value) || 0;
            const c = parseFloat(document.getElementById('customCarbs').value) || 0;
            const f = parseFloat(document.getElementById('customFat').value) || 0;

            // Only update if there are some values
            if (p > 0 || c > 0 || f > 0) {
                const total = Math.round((p * 4) + (c * 4) + (f * 9));
                document.getElementById('customCalories').value = total;
            }
        }

        async function handleCustomFoodSubmit(e) {
            e.preventDefault();

            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Saving...';
            submitBtn.disabled = true;

            // Parse Serving Unit (Safety check)
            const rawUnit = document.getElementById('customServingUnit').value;
            const currentQty = parseFloat(document.getElementById('customServingSize').value) || 1;
            const parsed = parseServingUnitInput(rawUnit, currentQty);

            // Update visible fields just in case (optional, but good for consistency)
            if (parsed.status === 'normalized') {
                document.getElementById('customServingSize').value = parsed.qty;
                document.getElementById('customServingUnit').value = parsed.unit;
            }

            // Save Unit to LocalStorage for next time
            if (parsed.unit) {
                localStorage.setItem('lifestats_last_custom_unit', parsed.unit);
            }

            const foodData = {
                foodName: document.getElementById('customFoodName').value,
                brandName: document.getElementById('customBrand').value,
                servingSize: parsed.qty,
                servingUnit: parsed.unit,
                calories: parseInt(document.getElementById('customCalories').value),
                protein: parseFloat(document.getElementById('customProtein').value) || 0,
                carbs: parseFloat(document.getElementById('customCarbs').value) || 0,
                fat: parseFloat(document.getElementById('customFat').value) || 0,
                // Advanced
                cholesterol: parseFloat(document.getElementById('customCholesterol').value) || 0,
                sodium: parseFloat(document.getElementById('customSodium').value) || 0,
                fiber: parseFloat(document.getElementById('customFiber').value) || 0,
                sugar: parseFloat(document.getElementById('customSugar').value) || 0,
                saturatedFat: parseFloat(document.getElementById('customSatFat').value) || 0,
                transFat: parseFloat(document.getElementById('customTransFat').value) || 0,
                polyunsaturatedFat: parseFloat(document.getElementById('customPolyFat').value) || 0,
                monounsaturatedFat: parseFloat(document.getElementById('customMonoFat').value) || 0,
                addedSugar: parseFloat(document.getElementById('customAddedSugar').value) || 0,
                vitaminD: parseFloat(document.getElementById('customVitD').value) || 0,
                calcium: parseFloat(document.getElementById('customCalcium').value) || 0,
                iron: parseFloat(document.getElementById('customIron').value) || 0,
                potassium: parseFloat(document.getElementById('customPotassium').value) || 0,
                vitaminC: parseFloat(document.getElementById('customVitC').value) || 0,
            };

            const result = await storage.saveCustomFood(foodData);

            submitBtn.textContent = originalText;
            submitBtn.disabled = false;

            if (result) {
                closeCustomFoodModal();
                // Select the food in the main form so user can log it immediately
                selectFood(result);
                showNotification('Custom food added, add meal to track it!');
            }
        }

        // Close custom food modal on background click
        customFoodModal.addEventListener('click', (e) => {
            if (e.target === customFoodModal) {
                closeCustomFoodModal();
            }
        });

        // Close on ESC key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !customFoodModal.classList.contains('hidden')) {
                closeCustomFoodModal();
            }
        });

        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js', { updateViaCache: 'none' })
                .then(reg => {
                    console.log('Service Worker registered:', reg);
                    // Check for updates
                    reg.addEventListener('updatefound', () => {
                        const newWorker = reg.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // New worker installed, reload will happen via controllerchange
                                console.log('New version available, reloading...');
                            }
                        });
                    });
                })
                .catch(err => console.log('Service Worker registration failed:', err));

            // Automatic reload when new service worker takes control
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                window.location.reload();
            });
        }

        // ===== EVENT TYPES FUNCTIONS =====
        let allEventTypes = [];
        let currentCategoryFilter = 'all';

        async function loadEventTypes(userId, category = null) {
            try {
                const url = new URL(`/api/event-types`, window.location.origin);
                if (userId) url.searchParams.append('userId', userId);
                if (category && category !== 'all') url.searchParams.append('category', category);

                // Calculate local start of day
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const startOfDay = today.getTime();

                const [eventsResponse, statsResponse] = await Promise.all([
                    fetch(url),
                    userId ? fetch(`/api/stats/today?userId=${userId}&startOfDay=${startOfDay}`) : Promise.resolve({ ok: false })
                ]);

                if (!eventsResponse.ok) throw new Error('Failed to fetch event types');

                allEventTypes = await eventsResponse.json();

                let todaysStats = {};
                if (statsResponse.ok) {
                    todaysStats = await statsResponse.json();
                    window.todaysStatsCache = todaysStats; // Cache for Home page
                }

                displayEventTypes(allEventTypes, todaysStats);

                // Refresh Goals tab chips if function exists
                if (typeof renderGoalsEventTypeChips === 'function') {
                    renderGoalsEventTypeChips();
                }
            } catch (error) {
                console.error('Error loading event types:', error);
                document.getElementById('eventTypesList').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-emoji">‚ùå</div>
                        <p>Failed to load event types</p>
                    </div>
                `;
            }
        }

        function displayEventTypes(eventTypes, todaysStats = {}) {
            const container = document.getElementById('eventTypesList');

            if (!eventTypes || eventTypes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-emoji">üìä</div>
                        <p>No event types found</p>
                    </div>
                `;
                return;
            }

            // Sort: Favorites first, then Last Used (desc), then Alphabetical
            eventTypes.sort((a, b) => {
                // 1. Favorites first
                if (a.isFavorite && !b.isFavorite) return -1;
                if (!a.isFavorite && b.isFavorite) return 1;

                // 2. Last Used (descending)
                const lastUsedA = a.lastUsed || 0;
                const lastUsedB = b.lastUsed || 0;
                if (lastUsedA !== lastUsedB) {
                    return lastUsedB - lastUsedA;
                }

                // 3. Alphabetical fallback
                return a.name.localeCompare(b.name);
            });

            container.innerHTML = eventTypes.map(et => {
                let rightSideContent = '';
                const trackingType = et.trackingType || 'count';

                if (trackingType === 'count') {
                    rightSideContent = `
                        <button class="quick-log-btn" onclick="quickLogEvent(event, '${et.id}', '${et.category}', ${JSON.stringify(et).replace(/"/g, "&quot;")})"
                            style="background: #2ECC71; border: none; border-radius: 50%; width: 40px; height: 40px; color: white; font-size: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3);">
                            +
                        </button>
                    `;
                } else if (trackingType === 'rating') {
                    // New Two-Step Rating UI
                    rightSideContent = `
                        <div class="rating-container" id="rating_container_${et.id}" data-rating="0" style="display: flex; align-items: center;" onclick="event.stopPropagation()">
                            <div style="display: flex;">
                                ${[1, 2, 3, 4, 5].map(i => `
                                    <span class="rating-star-btn" id="star_${et.id}_${i}" onclick="selectRating('${et.id}', ${i})">‚òÖ</span>
                                `).join('')}
                            </div>
                            <button class="check-btn" onclick="submitRating('${et.id}', '${et.category}', ${JSON.stringify(et).replace(/"/g, "&quot;")})">
                                ‚úì
                            </button>
                        </div>
                    `;
                } else if (trackingType === 'number') {
                    rightSideContent = `
                        <div style="display: flex; gap: 8px; align-items: center;" onclick="event.stopPropagation()">
                            <input type="number" 
                                   id="quick_input_${et.id}"
                                   placeholder="#" 
                                   style="width: 60px; padding: 6px; border-radius: 8px; border: 1px solid #3f3f46; background: rgba(0,0,0,0.2); color: white; text-align: center;"
                                   onclick="event.stopPropagation()">
                            <button onclick="quickLogEventNumber(event, '${et.id}', '${et.category}', ${JSON.stringify(et).replace(/"/g, "&quot;")})"
                                    style="background: #2ECC71; border: none; border-radius: 8px; padding: 6px 12px; color: white; cursor: pointer;">
                                ‚úì
                            </button>
                        </div>
                    `;
                }

                // Today's Stats Logic
                let statsHtml = '';
                if (todaysStats[et.id] && todaysStats[et.id].value > 0) {
                    const stat = todaysStats[et.id];
                    // Only show if aggregation is relevant
                    const unit = stat.unit || et.primaryUnit || '';
                    statsHtml = `<div style="font-size: 0.85em; color: #a1a1aa; margin-top: 4px;">Today: <span style="color: ${et.color}; font-weight: bold;">${parseFloat(stat.value.toFixed(1))} ${unit}</span></div>`;
                }

                return `
                <div class="event-type-row" data-category="${et.category}" onclick='openEventTrackingPage(${JSON.stringify(et).replace(/'/g, "&apos;")})' style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div class="event-type-icon" style="background: ${et.color}20; color: ${et.color};">
                            ${et.icon || 'üìä'}
                        </div>
                        <div class="event-type-info">
                            <div class="event-type-name">${et.name}</div>
                            <div class="event-type-meta">
                                <span class="event-type-category">${et.category}</span>
                            </div>
                            ${statsHtml}
                        </div>
                    </div>
                    <div class="event-type-actions">
                        ${rightSideContent}
                    </div>
                </div>
            `}).join('');
        }

        function filterEventTypesByCategory(category) {
            currentCategoryFilter = category;

            // Update active chip
            document.querySelectorAll('.category-chip').forEach(chip => {
                chip.classList.remove('active');
                if (chip.dataset.category === category) {
                    chip.classList.add('active');
                }
            });

            // Filter event types
            if (category === 'all') {
                displayEventTypes(allEventTypes);
            } else {
                const filtered = allEventTypes.filter(et => et.category === category);
                displayEventTypes(filtered);
            }
        }

        let additionalUnitCounter = 0;

        function getOrdinal(n) {
            const s = ["th", "st", "nd", "rd"];
            const v = n % 100;
            return n + (s[(v - 20) % 10] || s[v] || s[0]);
        }

        function renumberAdditionalUnits() {
            const rows = document.querySelectorAll('.additional-unit-row');
            rows.forEach((row, index) => {
                const number = index + 2; // Primary is 1, so start at 2
                const label = row.querySelector('.unit-row-label');
                if (label) {
                    label.textContent = `${getOrdinal(number)} Unit`;
                }
            });
        }

        function addAdditionalUnitField() {
            const container = document.getElementById('additionalUnitsContainer');
            const id = `additional_unit_${additionalUnitCounter++}`;

            const div = document.createElement('div');
            div.className = 'form-group additional-unit-row';
            div.id = id;
            div.style.background = 'rgba(39, 39, 42, 0.3)';
            div.style.padding = '12px';
            div.style.borderRadius = '8px';
            div.style.marginBottom = '12px';

            div.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                     <label class="unit-row-label" style="margin-bottom: 0; color: #e4e4e7;">Additional Unit</label>
                     <div style="display: flex; align-items: center; gap: 12px;">
                        <label style="display: inline-flex; align-items: center; gap: 6px; cursor: pointer; margin-bottom: 0;">
                            <input type="checkbox" name="unit_required" style="width: auto; margin: 0;">
                            <span style="font-size: 0.8em; color: #a1a1aa;">Required</span>
                        </label>
                        <button type="button" class="meal-delete" onclick="removeAdditionalUnitField('${id}')" style="padding: 4px 8px; font-size: 0.8em;">Delete</button>
                     </div>
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <input type="text" name="unit_label" placeholder="Label (e.g. Calories)" required style="flex: 1">
                    <input type="text" name="unit_symbol" placeholder="Unit (e.g. kcal)" required style="flex: 1">
                </div>
            `;
            container.appendChild(div);
            renumberAdditionalUnits();
        }

        function removeAdditionalUnitField(id) {
            document.getElementById(id)?.remove();
            renumberAdditionalUnits();
        }

        // Global state for editing
        let editingEventTypeId = null;

        function openAddEventTypeModal() {
            editingEventTypeId = null; // Reset edit mode
            const modal = document.getElementById('addEventTypeModalOverlay');
            modal.querySelector('.modal-title').textContent = 'Add Event Type';
            modal.querySelector('button[type="submit"]').textContent = 'Create Event Type';

            // Hide delete button
            document.getElementById('deleteEventTypeBtn').classList.add('hidden');

            modal.classList.remove('hidden');
            // Reset form
            document.getElementById('addEventTypeForm').reset();
            document.getElementById('eventTypeIcon').value = 'üìä';
            document.getElementById('eventTypeColor').value = '#9C27B0';

            // Clear additional units
            document.getElementById('additionalUnitsContainer').innerHTML = '';
            additionalUnitCounter = 0;

            // Show all fields by default
            document.querySelectorAll('#addEventTypeForm .form-group').forEach(el => el.style.display = 'block');
        }

        function openEditEventTypeModal(eventType) {
            editingEventTypeId = eventType.id;
            const modal = document.getElementById('addEventTypeModalOverlay');
            modal.querySelector('.modal-title').textContent = 'Edit Event Type';
            modal.querySelector('button[type="submit"]').textContent = 'Save Changes';

            // Show delete button
            document.getElementById('deleteEventTypeBtn').classList.remove('hidden');

            modal.classList.remove('hidden');
            document.getElementById('addEventTypeForm').reset();

            // Populate basic fields
            document.getElementById('eventTypeName').value = eventType.name;
            document.getElementById('eventTypeCategory').value = eventType.category;
            document.getElementById('eventTypeIcon').value = eventType.icon;
            document.getElementById('eventTypeColor').value = eventType.color;
            document.getElementById('eventTypeAggregation').value = eventType.aggregationType;
            document.getElementById('eventTypeTracking').value = eventType.trackingType || 'number';

            // Populate Units
            document.getElementById('additionalUnitsContainer').innerHTML = '';
            additionalUnitCounter = 0;

            if (eventType.fieldSchema && eventType.fieldSchema.fields && eventType.fieldSchema.fields.length > 0) {
                // Primary Unit (First field)
                const primaryField = eventType.fieldSchema.fields[0];
                document.getElementById('eventTypePrimaryLabel').value = primaryField.label;
                document.getElementById('eventTypePrimaryUnit').value = primaryField.unit;

                // Additional Units (Rest)
                for (let i = 1; i < eventType.fieldSchema.fields.length; i++) {
                    const field = eventType.fieldSchema.fields[i];
                    addAdditionalUnitField(); // Adds empty row

                    // Get the last added row (current counter - 1)
                    const rows = document.querySelectorAll('.additional-unit-row');
                    const row = rows[rows.length - 1];

                    row.querySelector('input[name="unit_label"]').value = field.label;
                    row.querySelector('input[name="unit_symbol"]').value = field.unit;
                    row.querySelector('input[name="unit_required"]').checked = field.required;
                }
            }
        }

        async function handleDeleteEventType() {
            if (!editingEventTypeId) return;

            if (confirm("Are you sure you want to delete this event type?\n\nWARNING: All logged history for this event will be permanently lost!")) {
                const userId = localStorage.getItem('lifestats_userId');
                try {
                    const response = await fetch(`/api/event-types/${editingEventTypeId}?userId=${userId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        showNotification('Event type deleted');
                        closeAddEventTypeModal();

                        // If we are on the tracking page for this event, go back to Stats
                        if (currentEventType && currentEventType.id === editingEventTypeId) {
                            closeEventTrackingPage();
                        }

                        // Reload list
                        await loadEventTypes(userId, currentCategoryFilter === 'all' ? null : currentCategoryFilter);
                    } else {
                        const err = await response.json();
                        alert('Failed to delete: ' + (err.error || 'Unknown error'));
                    }
                } catch (e) {
                    console.error(e);
                    alert('Error deleting event type');
                }
            }
        }

        function closeAddEventTypeModal() {
            const modal = document.getElementById('addEventTypeModalOverlay');
            modal.classList.add('hidden');
            editingEventTypeId = null;
        }

        async function handleAddEventTypeSubmit(event) {
            event.preventDefault();

            const userId = localStorage.getItem('lifestats_userId');
            if (!userId) {
                alert('Please set your User ID in settings first');
                return;
            }

            const primaryLabel = document.getElementById('eventTypePrimaryLabel').value;
            const primaryUnit = document.getElementById('eventTypePrimaryUnit').value;

            // Construct fields array
            const fields = [
                {
                    name: primaryLabel.toLowerCase().replace(/[^a-z0-9]/g, '_'),
                    type: 'number',
                    required: true,
                    label: primaryLabel,
                    unit: primaryUnit
                }
            ];

            // Add additional units
            const additionalRows = document.querySelectorAll('.additional-unit-row');
            additionalRows.forEach(row => {
                const label = row.querySelector('input[name="unit_label"]').value;
                const unit = row.querySelector('input[name="unit_symbol"]').value;
                const required = row.querySelector('input[name="unit_required"]').checked;

                if (label && unit) {
                    fields.push({
                        name: label.toLowerCase().replace(/[^a-z0-9]/g, '_'),
                        type: 'number',
                        required: required,
                        label: label,
                        unit: unit
                    });
                }
            });

            const formData = {
                name: document.getElementById('eventTypeName').value,
                category: document.getElementById('eventTypeCategory').value,
                icon: document.getElementById('eventTypeIcon').value || 'üìä',
                color: document.getElementById('eventTypeColor').value,
                primaryUnit: primaryUnit,
                aggregationType: document.getElementById('eventTypeAggregation').value,
                trackingType: document.getElementById('eventTypeTracking').value,
                fieldSchema: {
                    fields: fields
                }
            };

            try {
                let url = `/api/event-types?userId=${userId}`;
                let method = 'POST';

                if (editingEventTypeId) {
                    url = `/api/event-types/${editingEventTypeId}?userId=${userId}`;
                    method = 'PUT';
                }

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to save event type');
                }

                // Show success notification
                showNotification(editingEventTypeId ? 'Event type updated!' : 'Event type created!');

                // Close modal
                closeAddEventTypeModal();

                // Reload event types
                await loadEventTypes(userId, currentCategoryFilter === 'all' ? null : currentCategoryFilter);

                // If we were viewing this event type, refresh the header/view
                if (currentEventType && editingEventTypeId === currentEventType.id) {
                    // We need to reload the current event type data
                    // Since we just reloaded allEventTypes, we can find it there
                    const updatedEt = allEventTypes.find(et => et.id === editingEventTypeId);
                    if (updatedEt) {
                        openEventTrackingPage(updatedEt);
                    }
                }

            } catch (error) {
                console.error('Error saving event type:', error);
                alert(`Failed to save event type: ${error.message}`);
            }
        }

        // Close modal on background click
        document.getElementById('addEventTypeModalOverlay')?.addEventListener('click', (e) => {
            if (e.target.id === 'addEventTypeModalOverlay') {
                closeAddEventTypeModal();
            }
        });

        // Close on ESC key for add event type modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !document.getElementById('addEventTypeModalOverlay').classList.contains('hidden')) {
                closeAddEventTypeModal();
            }
        });

        // Load event types when switching to stats page
        const originalSwitchPage = window.switchPage; // Use window.switchPage to avoid redeclaration if it's already global
        window.switchPage = function (pageNumber) {
            originalSwitchPage(pageNumber);

            // If switching to stats page (page 1), load event types
            if (pageNumber === 1) {
                const userId = localStorage.getItem('lifestats_userId');
                if (userId) {
                    loadEventTypes(userId);
                }
            }

            // If switching to Me page (page 4), load goals
            if (pageNumber === 4) {
                const userId = localStorage.getItem('lifestats_userId');
                if (userId) {
                    loadUserGoals(userId);
                }
            }

            // If switching to meal page (page 3), update favorite button
            if (pageNumber === 3) {
                updateMealFavoriteButton();
            }

            // If switching to home page (page 7), render favorites
            if (pageNumber === 7) {
                renderHomeFavorites();
            }
        };

        // Update favorite button for Meal page
        function updateMealFavoriteButton() {
            const container = document.getElementById('mealFavoriteContainer');
            if (!container) return;

            // Find the 'meal' event type in allEventTypes
            const mealEventType = allEventTypes.find(et => et.id === 'meal');
            const isFavorite = mealEventType ? mealEventType.isFavorite : false;

            container.innerHTML = `
                <button id="mealFavoriteBtn" onclick='toggleMealFavorite(${isFavorite})'
                    style="background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 8px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: ${isFavorite ? '#FFD700' : '#a1a1aa'}; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);">
                    ${isFavorite ? '‚òÖ' : '‚òÜ'}
                </button>
            `;
        }

        // Toggle favorite for Meal event type
        async function toggleMealFavorite(currentStatus) {
            const newStatus = !currentStatus;
            const userId = localStorage.getItem('lifestats_userId');
            if (!userId) return;

            // Optimistic UI update
            const btn = document.getElementById('mealFavoriteBtn');
            if (btn) {
                btn.innerHTML = newStatus ? '‚òÖ' : '‚òÜ';
                btn.style.color = newStatus ? '#FFD700' : '#a1a1aa';
            }

            // Update in allEventTypes
            const mealIndex = allEventTypes.findIndex(et => et.id === 'meal');
            if (mealIndex !== -1) {
                allEventTypes[mealIndex].isFavorite = newStatus;
            }

            try {
                await fetch(`/api/event-types/meal/favorite?userId=${userId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ isFavorite: newStatus })
                });

                // Update button onclick for next toggle
                if (btn) {
                    btn.onclick = () => toggleMealFavorite(newStatus);
                }

            } catch (error) {
                console.error('Error toggling meal favorite:', error);
                // Revert on error
                if (btn) {
                    btn.innerHTML = currentStatus ? '‚òÖ' : '‚òÜ';
                    btn.style.color = currentStatus ? '#FFD700' : '#a1a1aa';
                }
            }
        }

        // ===== EVENT TRACKING PAGE FUNCTIONS =====
        let currentEventType = null;

        function openEventTrackingPage(eventType) {
            // Special case for 'Meal' event type - go to Food Page
            if (eventType.id === 'meal') {
                switchPage(3);
                return;
            }

            currentEventType = eventType;

            // Update title
            document.getElementById('eventTrackingTitle').innerHTML = `${eventType.icon || 'üìä'} ${eventType.name}`;

            // Handle Edit Button Placement
            // We target the right spacer in the header
            const rightActionContainer = document.getElementById('eventTrackingHeaderActions');
            if (rightActionContainer) {
                // Show favorite button for ALL event types (system AND custom)
                let buttonsHtml = `
                    <button id="favoriteBtn" onclick='toggleFavoriteEventType("${eventType.id}", ${eventType.isFavorite})'
                        style="background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 8px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: ${eventType.isFavorite ? '#FFD700' : '#a1a1aa'}; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);">
                        ${eventType.isFavorite ? '‚òÖ' : '‚òÜ'}
                    </button>
                `;

                // Only show Edit button for Custom Types
                if (eventType.userId) {
                    buttonsHtml += `
                    <button onclick='openEditEventTypeModal(${JSON.stringify(eventType).replace(/'/g, "&apos;")})'
                        style="background: #2ECC71; border: none; border-radius: 8px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3);">
                        <span style="font-size: 1.2em;">‚úèÔ∏è</span>
                    </button>
                    `;
                }

                rightActionContainer.innerHTML = `<div style="display: flex; gap: 8px;">${buttonsHtml}</div>`;
                rightActionContainer.style.width = 'auto';
            }

            // Render form fields
            renderEventForm(eventType.fieldSchema);

            // Load event history
            const userId = localStorage.getItem('lifestats_userId');
            if (userId) {
                loadEventHistory(eventType.id, userId);
            }

            // Switch to page 6
            switchPage(6);
        }

        function closeEventTrackingPage() {
            currentEventType = null;
            switchPage(1); // Return to Stats tab
        }

        function renderEventForm(fieldSchema) {
            const container = document.getElementById('eventFormFields');

            if (!fieldSchema || !fieldSchema.fields) {
                container.innerHTML = '<p style="color: #71717a;">No fields defined for this event type.</p>';
                return;
            }

            container.innerHTML = fieldSchema.fields.map(field => {
                const required = field.required ? '*' : '';
                const requiredAttr = field.required ? 'required' : '';

                if (field.type === 'number') {
                    return `
                        <div class="form-group">
                            <label for="field_${field.name}">${field.label || field.name}${required}</label>
                            <input type="number" 
                                   id="field_${field.name}" 
                                   name="${field.name}"
                                   placeholder="${field.unit ? `Enter ${field.unit}` : '0'}" 
                                   step="any" 
                                   ${requiredAttr}>
                            ${field.unit ? `<small style="color: #71717a; font-size: 0.85em; margin-top: 4px; display: block;">Unit: ${field.unit}</small>` : ''}
                        </div>
                    `;
                } else if (field.type === 'string') {
                    return `
                        <div class="form-group">
                            <label for="field_${field.name}">${field.label || field.name}${required}</label>
                            <input type="text" 
                                   id="field_${field.name}" 
                                   name="${field.name}"
                                   placeholder="${field.label || field.name}" 
                                   ${requiredAttr}>
                        </div>
                    `;
                } else if (field.type === 'enum') {
                    return `
                        <div class="form-group">
                            <label for="field_${field.name}">${field.label || field.name}${required}</label>
                            <select id="field_${field.name}" 
                                    name="${field.name}"
                                    ${requiredAttr}
                                    style="width: 100%; padding: 12px; background: rgba(39, 39, 42, 0.6); border: 1px solid #3f3f46; border-radius: 8px; color: #e4e4e7; font-size: 1em;">
                                ${field.values.map(val => `<option value="${val}">${val}</option>`).join('')}
                            </select>
                        </div>
                    `;
                }
                return '';
            }).join('');
        }

        async function handleEventSubmit(event) {
            event.preventDefault();

            const userId = localStorage.getItem('lifestats_userId');
            if (!userId) {
                alert('Please set your User ID in settings first');
                return;
            }

            if (!currentEventType) {
                alert('No event type selected');
                return;
            }

            // Collect form data
            const formData = {};
            const form = document.getElementById('eventTrackingForm');
            const inputs = form.querySelectorAll('input, select');

            inputs.forEach(input => {
                if (input.name) {
                    const value = input.type === 'number' ? parseFloat(input.value) : input.value;
                    formData[input.name] = value;
                }
            });

            const eventData = {
                id: `event-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                userId: userId,
                eventTypeId: currentEventType.id,
                timestamp: Date.now(),
                category: currentEventType.category,
                data: formData,
                notes: ''
            };

            try {
                const response = await fetch(`/api/events`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(eventData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to log event');
                }

                // Show success notification
                showNotification('Event logged successfully!');

                // Reset form
                form.reset();

                // Reload event history
                await loadEventHistory(currentEventType.id, userId);

            } catch (error) {
                console.error('Error logging event:', error);
                alert(`Failed to log event: ${error.message}`);
            }
        }

        async function loadEventHistory(eventTypeId, userId) {
            try {
                const url = new URL(`/api/events`, window.location.origin);
                url.searchParams.append('userId', userId);
                url.searchParams.append('eventTypeId', eventTypeId);
                url.searchParams.append('limit', '50');

                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to fetch events');

                const events = await response.json();
                displayEventHistory(events);
            } catch (error) {
                console.error('Error loading event history:', error);
                document.getElementById('eventHistoryList').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-emoji">‚ùå</div>
                        <p>Failed to load event history</p>
                    </div>
                `;
            }
        }

        function displayEventHistory(events) {
            const container = document.getElementById('eventHistoryList');

            if (!events || events.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-emoji">üìã</div>
                        <p>No events logged yet</p>
                    </div>
                `;
                return;
            }

            // Group events by date
            const groupedEvents = {};
            events.forEach(event => {
                const date = new Date(event.timestamp);
                const dateKey = date.toLocaleDateString();
                if (!groupedEvents[dateKey]) {
                    groupedEvents[dateKey] = [];
                }
                groupedEvents[dateKey].push(event);
            });

            container.innerHTML = Object.entries(groupedEvents).map(([date, dateEvents]) => `
                <div style="margin-bottom: 20px;">
                    <div style="font-weight: 600; color: #a1a1aa; margin-bottom: 8px; font-size: 0.9em;">${date}</div>
                    ${dateEvents.map(event => {
                const time = new Date(event.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const dataStr = Object.entries(event.data).map(([key, val]) => `${key}: ${val}`).join(', ');

                return `
                            <div class="meal-item" style="margin-bottom: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: 500; color: #e4e4e7;">${dataStr}</div>
                                        <div style="font-size: 0.85em; color: #71717a; margin-top: 2px;">${time}</div>
                                    </div>
                                </div>
                            </div>
                        `;
            }).join('')}
                </div>
            `).join('');
        }

        // ===== QUICK LOGGING FUNCTIONS =====

        function selectRating(eventTypeId, value) {
            const container = document.getElementById(`rating_container_${eventTypeId}`);
            if (!container) return;

            // Set data attribute
            container.dataset.rating = value;

            // Update visual state
            for (let i = 1; i <= 5; i++) {
                const star = document.getElementById(`star_${eventTypeId}_${i}`);
                if (i <= value) {
                    star.classList.add('active');
                    star.style.color = '#FFD700';
                } else {
                    star.classList.remove('active');
                    star.style.color = '#555';
                }
            }
        }

        async function submitRating(eventTypeId, category, eventTypeObj) {
            event.stopPropagation(); // prevent row click

            const container = document.getElementById(`rating_container_${eventTypeId}`);
            const value = parseInt(container.dataset.rating);

            if (!value || value === 0) {
                alert('Please select a rating first');
                return;
            }

            // Log it
            await quickLogEvent(null, eventTypeId, category, eventTypeObj, value);

            // Reset visual state
            selectRating(eventTypeId, 0);
        }

        async function quickLogEventNumber(event, eventTypeId, category, eventTypeObj) {
            event.stopPropagation();
            const input = document.getElementById(`quick_input_${eventTypeId}`);
            const value = parseFloat(input.value);

            if (isNaN(value)) {
                alert('Please enter a valid number');
                return;
            }

            await quickLogEvent(null, eventTypeId, category, eventTypeObj, value);

            // Clear input
            input.value = '';
        }

        async function quickLogEvent(event, eventTypeId, category, eventTypeObj, value = 1) {
            if (event) event.stopPropagation();

            const userId = localStorage.getItem('lifestats_userId');
            if (!userId) return;

            // Construct payload based on schema
            // For simple tracking, we assume the single 'value' field is what we want
            // If schema has multiple fields, we might need a default mapping
            const formData = {
                value: value
            };

            const eventData = {
                id: `event-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                userId: userId,
                eventTypeId: eventTypeId,
                timestamp: Date.now(),
                category: category,
                data: formData,
                notes: 'Quick log'
            };

            try {
                // Optimistic UI update (optional, but good for UX)
                showNotification('Logging...');

                const response = await fetch(`/api/events`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(eventData)
                });

                if (!response.ok) throw new Error('Failed to log');

                showNotification('Saved! ‚úÖ');

                // Refresh stats
                if (navigator.vibrate) navigator.vibrate(50);
                await loadEventTypes(userId, currentCategoryFilter === 'all' ? null : currentCategoryFilter);

            } catch (error) {
                console.error('Quick log error:', error);
                showNotification('Failed to save ‚ùå');
            }
        }




        // ===== ME / PROFILE PAGE LOGIC =====

        // Wheel Data
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        let wheelsInitialized = false;

        async function loadProfilePage() {
            const userId = localStorage.getItem('lifestats_userId');
            if (!userId) return;

            // Elements
            const setupCard = document.getElementById('profileSetupCard');
            const displayCard = document.getElementById('profileDisplayCard');
            const loadingCard = document.getElementById('profileLoadingCard');

            // Show loading
            setupCard.classList.add('hidden');
            displayCard.classList.add('hidden');
            loadingCard.style.display = 'block';

            // Initialize Wheels (once)
            if (!wheelsInitialized) {
                initAllWheels();
                wheelsInitialized = true;
            }

            try {
                // Fetch profile and weight in parallel
                const [profileRes, weightRes] = await Promise.all([
                    fetch(`/api/profile?userId=${userId}`),
                    fetch(`/api/profile/weight?userId=${userId}`)
                ]);

                const profile = await profileRes.json();
                const weightData = await weightRes.json();

                if (profile) {
                    // Show Display Card
                    displayCard.classList.remove('hidden');

                    // Fill Data
                    document.getElementById('profileDisplaySex').textContent = profile.sex || '-';
                    document.getElementById('profileDisplayAge').textContent = calculateAge(profile.birthdate) || '-';

                    const ft = Math.floor((profile.heightInches || 0) / 12);
                    const inch = (profile.heightInches || 0) % 12;
                    document.getElementById('profileDisplayHeight').textContent = `${ft}' ${inch}"`;

                    document.getElementById('profileDisplayWeight').textContent = weightData ? `${weightData.weight} lbs` : '-';

                    loadingCard.style.display = 'none';
                } else {
                    // Show Setup Form
                    setupCard.classList.remove('hidden');
                    // Set defaults for wheels
                    setWheelToDefault();
                    loadingCard.style.display = 'none';
                }

            } catch (error) {
                console.error('Error loading profile:', error);
                loadingCard.innerHTML = '<div class="empty-state"><p>Error loading profile</p></div>';
            }
        }

        async function handleProfileSubmit(event) {
            event.preventDefault();

            const userId = localStorage.getItem('lifestats_userId');
            if (!userId) return;

            const sex = document.getElementById('profileSex').value;

            // Get from hidden inputs
            const m = document.getElementById('dobMonth').value;
            const d = document.getElementById('dobDay').value;
            const y = document.getElementById('dobYear').value;

            const feet = parseInt(document.getElementById('profileHeightFeet').value || 0);
            const inches = parseInt(document.getElementById('profileHeightInches').value || 0);
            const weight = parseFloat(document.getElementById('profileWeight').value);

            // Validation
            if (!sex || m === '' || d === '' || y === '' || isNaN(weight) || !feet) {
                alert('Please fill in all required fields');
                return;
            }

            // Pad month/day for ISO format YYYY-MM-DD
            // Month is 0-indexed from wheel
            const monthNum = parseInt(m) + 1;
            const birthdate = `${y}-${monthNum.toString().padStart(2, '0')}-${d.toString().padStart(2, '0')}`;

            const totalInches = (feet * 12) + inches;

            try {
                // 1. Save Profile
                const profileData = {
                    userId: userId,
                    sex: sex,
                    birthdate: birthdate,
                    heightInches: totalInches
                };

                const profileRes = await fetch('/api/profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(profileData)
                });

                if (!profileRes.ok) throw new Error('Failed to save profile');

                // 2. Log Weight Event
                const weightEventData = {
                    id: `event-weight-${Date.now()}`,
                    userId: userId,
                    eventTypeId: 'weight',
                    timestamp: Date.now(),
                    category: 'Health',
                    data: {
                        weight: weight
                    },
                    notes: 'Initial profile weight'
                };

                await fetch('/api/events', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(weightEventData)
                });

                showNotification('Profile setup complete! ‚úÖ');

                // Reload Page View
                loadProfilePage();

            } catch (error) {
                console.error('Error saving profile:', error);
                alert('Failed to save profile. Please try again.');
            }
        }

        function showProfileEditForm() {
            const userId = localStorage.getItem('lifestats_userId');

            if (!wheelsInitialized) {
                initAllWheels();
                wheelsInitialized = true;
            }

            if (userId) {
                fetch(`/api/profile?userId=${userId}`)
                    .then(res => res.json())
                    .then(profile => {
                        if (profile) {
                            // Sex
                            selectSex(profile.sex);

                            // Date Split
                            if (profile.birthdate) {
                                // YYYY-MM-DD
                                const parts = profile.birthdate.split('-');
                                if (parts.length === 3) {
                                    const y = parseInt(parts[0]);
                                    const m = parseInt(parts[1]) - 1; // 0-indexed
                                    const d = parseInt(parts[2]);

                                    // Scroll wheels to match
                                    scrollToValue('col_dobYear', y);
                                    scrollToValue('col_dobMonth', m);
                                    // Update days then scroll
                                    updateDayWheel();
                                    setTimeout(() => scrollToValue('col_dobDay', d), 50);
                                }
                            }

                            // Height
                            const ft = Math.floor((profile.heightInches || 0) / 12);
                            const inch = (profile.heightInches || 0) % 12;
                            scrollToValue('col_heightFeet', ft);
                            scrollToValue('col_heightInches', inch);
                        }
                    });

                fetch(`/api/profile/weight?userId=${userId}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data) {
                            document.getElementById('profileWeight').value = data.weight;
                        }
                    });
            }

            document.getElementById('profileDisplayCard').classList.add('hidden');
            document.getElementById('profileSetupCard').classList.remove('hidden');
        }

        function calculateAge(birthdateStr) {
            if (!birthdateStr) return null;
            const birthDate = new Date(birthdateStr);
            const otherDate = new Date();
            let years = (otherDate.getFullYear() - birthDate.getFullYear());

            if (otherDate.getMonth() < birthDate.getMonth() ||
                (otherDate.getMonth() == birthDate.getMonth() && otherDate.getDate() < birthDate.getDate())) {
                years--;
            }
            return years;
        }

        // ===== WHEEL PICKER LOGIC =====

        function selectSex(value) {
            document.getElementById('profileSex').value = value;
            document.getElementById('btnSexMale').classList.toggle('active', value === 'male');
            document.getElementById('btnSexFemale').classList.toggle('active', value === 'female');
        }

        function initAllWheels() {
            // Month
            initWheel('col_dobMonth', 'wheel_dobMonth', 'dobMonth',
                monthNames.map((m, i) => ({ val: i, text: m })),
                updateDayWheel
            );

            // Year: 1900 - Current
            const years = [];
            const currentYear = new Date().getFullYear();
            for (let y = currentYear; y >= 1900; y--) years.push({ val: y, text: y });
            initWheel('col_dobYear', 'wheel_dobYear', 'dobYear', years, updateDayWheel);

            // Day (initially 31)
            initWheel('col_dobDay', 'wheel_dobDay', 'dobDay',
                Array.from({ length: 31 }, (_, i) => ({ val: i + 1, text: i + 1 }))
            );

            // Height Feet (1-8)
            initWheel('col_heightFeet', 'wheel_heightFeet', 'profileHeightFeet',
                Array.from({ length: 8 }, (_, i) => ({ val: i + 1, text: `${i + 1}'` }))
            );

            // Height Inches (0-11)
            initWheel('col_heightInches', 'wheel_heightInches', 'profileHeightInches',
                Array.from({ length: 12 }, (_, i) => ({ val: i, text: `${i}"` }))
            );
        }

        function initWheel(colId, listId, inputId, items, onChangeCallback) {
            const container = document.getElementById(listId);
            if (!container) return;

            // Populate
            container.innerHTML = items.map(item =>
                `<div class="picker-item" data-value="${item.val}">${item.text}</div>`
            ).join('');

            // Attach Scroll Listener
            const col = document.getElementById(colId);
            col.dataset.inputId = inputId;

            // Function to handle scroll update
            const handleScroll = () => {
                const itemHeight = 40;
                const index = Math.round(col.scrollTop / itemHeight);
                const safeIndex = Math.max(0, Math.min(index, items.length - 1));

                // Get value
                const value = items[safeIndex].val;
                document.getElementById(inputId).value = value;

                // Active class for visual (optional, but good for polish)
                Array.from(container.children).forEach((child, i) => {
                    child.style.opacity = i === safeIndex ? '1' : '0.4';
                    child.style.transform = i === safeIndex ? 'scale(1.1)' : 'scale(1)';
                });

                if (onChangeCallback) onChangeCallback();
            };

            col.addEventListener('scroll', handleScroll);

            // Trigger once to set initial value
            handleScroll();
        }

        function updateDayWheel() {
            const month = parseInt(document.getElementById('dobMonth').value);
            const year = parseInt(document.getElementById('dobYear').value);

            if (isNaN(month) || isNaN(year)) return;

            // Days in month
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Current selection
            const currentDayInput = document.getElementById('dobDay');
            const currentVal = parseInt(currentDayInput.value);

            // Re-populate if needed (simple check: length)
            const list = document.getElementById('wheel_dobDay');
            if (list.children.length !== daysInMonth) {
                // Rebuild
                const items = Array.from({ length: daysInMonth }, (_, i) => ({ val: i + 1, text: i + 1 }));

                // Detach listener temporarily effectively by just rebuilding innerHTML
                // But we need to update the closure logic in listeners?
                // Actually the listener uses `container.children` and math, so strictly replacing innerHTML is fine 
                // IF we don't rely on closed-over `items` array.
                // Converting initWheel to be more dynamic is better.

                list.innerHTML = items.map(item =>
                    `<div class="picker-item" data-value="${item.val}">${item.text}</div>`
                ).join('');

                // We need to update the active item visual state again
                // Scroll to preserve value or clamp
                const newVal = Math.min(currentVal || 1, daysInMonth);
                scrollToValue('col_dobDay', newVal);
            }
        }

        // Helper to programmatically scroll a wheel to a value
        function scrollToValue(colId, value) {
            const col = document.getElementById(colId);
            if (!col) return;
            const list = col.querySelector('.picker-list');

            // Find item with value
            let targetIndex = -1;
            Array.from(list.children).forEach((child, index) => {
                // loose comparison for string/number match
                if (child.dataset.value == value) targetIndex = index;
            });

            if (targetIndex !== -1) {
                col.scrollTop = targetIndex * 40;
            } else if (list.children.length > 0) {
                col.scrollTop = 0; // Default to top
            }
        }

        function setWheelToDefault() {
            // Defaults: 
            // Year: 2000 (roughly middleish)
            scrollToValue('col_dobYear', 2000);
            // Month: Jan
            scrollToValue('col_dobMonth', 0);
            // Day: 1
            scrollToValue('col_dobDay', 1);
            // Height: 5' 9"
            scrollToValue('col_heightFeet', 5);
            scrollToValue('col_heightInches', 9);
        }

    </script>
    <!-- Add Goal Modal -->
    <div id="addGoalModalOverlay" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Set Goal</div>
                <button class="close-btn" onclick="closeAddGoalModal()">&times;</button>
            </div>
            <form id="addGoalForm" onsubmit="handleSaveGoal(event)">
                <div class="form-group">
                    <label>Event Type</label>
                    <div id="goalEventTypeChips" class="chip-container"
                        style="flex-wrap: wrap; gap: 8px; margin-top: 0;">
                        <!-- Chips inserted by JS -->
                    </div>
                    <input type="hidden" id="goalEventTypeId" required>
                </div>

                <div class="form-group">
                    <label>Target Value</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="number" id="goalTargetValue" placeholder="0" step="any" required
                            style="font-size: 1.2em; padding: 12px; font-weight: bold; text-align: center;">
                        <span id="goalTargetUnit" style="color: #a1a1aa; font-size: 1em; font-weight: 500;"></span>
                    </div>
                </div>

                <div class="form-group">
                    <label>Period</label>
                    <select id="goalPeriod"
                        style="width: 100%; padding: 12px; background: rgba(39, 39, 42, 0.6); border: 1px solid #3f3f46; border-radius: 8px; color: #e4e4e7;">
                        <option value="daily">Daily</option>
                    </select>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeAddGoalModal()">Cancel</button>
                    <button type="submit" class="primary-btn">Save Goal</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // GOALS FEATURE LOGIC

        // State
        let currentGoalEventTypeId = null;
        let userGoals = [];

        function openAddGoalModal() {
            document.getElementById('addGoalModalOverlay').classList.remove('hidden');
            document.getElementById('addGoalForm').reset();
            currentGoalEventTypeId = null;
            document.getElementById('goalEventTypeId').value = '';
            document.getElementById('goalTargetUnit').textContent = '';

            renderGoalEventTypeChips();
        }

        function closeAddGoalModal() {
            document.getElementById('addGoalModalOverlay').classList.add('hidden');
        }

        function renderGoalEventTypeChips() {
            const container = document.getElementById('goalEventTypeChips');

            const types = (typeof allEventTypes !== 'undefined' ? allEventTypes : [])
                .filter(et => et.isActive !== false);

            container.innerHTML = types.map(et => {
                const isSelected = currentGoalEventTypeId === et.id;
                const activeStyle = isSelected
                    ? `background: ${et.color}25; border-color: ${et.color}; color: ${et.color};`
                    : '';

                return `
                    <div class="chip" 
                         style="${activeStyle}"
                         onclick="selectGoalEventType('${et.id}')">
                        ${et.icon} ${et.name}
                    </div>
                `;
            }).join('');
        }

        function selectGoalEventType(eventTypeId) {
            currentGoalEventTypeId = eventTypeId;
            document.getElementById('goalEventTypeId').value = eventTypeId;
            renderGoalEventTypeChips();

            // Update Unit Label
            const et = allEventTypes.find(t => t.id === eventTypeId);
            if (et) {
                document.getElementById('goalTargetUnit').textContent = et.primaryUnit || '';
            }
        }

        async function handleSaveGoal(event) {
            event.preventDefault();
            const userId = localStorage.getItem('lifestats_userId');
            if (!userId) return;

            const eventTypeId = document.getElementById('goalEventTypeId').value;
            const targetValue = document.getElementById('goalTargetValue').value;
            const period = document.getElementById('goalPeriod').value;

            if (!eventTypeId) {
                alert('Please select an event type');
                return;
            }

            try {
                const response = await fetch('/api/goals', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId,
                        eventTypeId,
                        targetValue,
                        period
                    })
                });

                if (response.ok) {
                    showNotification('Goal saved!');
                    closeAddGoalModal();
                    loadUserGoals(userId);
                } else {
                    const err = await response.json();
                    alert('Error saving goal: ' + err.error);
                }
            } catch (e) {
                console.error(e);
                alert('Error saving goal');
            }
        }

        async function loadUserGoals(userId) {
            if (!userId) return;

            try {
                const response = await fetch(`/api/goals?userId=${userId}`);
                if (response.ok) {
                    userGoals = await response.json();
                    renderGoals();
                    document.getElementById('goalsCard').classList.remove('hidden');
                }
            } catch (e) {
                console.error('Error loading goals', e);
            }
        }

        function renderGoals() {
            const container = document.getElementById('goalsList');
            if (userGoals.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-emoji">üéØ</div>
                        <p>No goals set yet</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = userGoals.map(goal => {
                let et = (typeof allEventTypes !== 'undefined' ? allEventTypes : []).find(t => t.id === goal.eventTypeId);

                // Fallback to Virtual Types (Macros)
                if (!et) {
                    const virtualTypes = [
                        { id: 'protein', name: 'Protein', icon: 'ü•©', color: '#E91E63', primaryUnit: 'g' },
                        { id: 'carbs', name: 'Carbs', icon: 'üçû', color: '#FFC107', primaryUnit: 'g' },
                        { id: 'fat', name: 'Fat', icon: 'ü•ë', color: '#795548', primaryUnit: 'g' }
                    ];
                    et = virtualTypes.find(t => t.id === goal.eventTypeId);
                }

                if (!et) return '';

                // Get current value from cache (calculated on stats page load)
                // We trust todaysStatsCache is available globally
                const currentStat = (typeof todaysStatsCache !== 'undefined' && todaysStatsCache[et.id])
                    ? todaysStatsCache[et.id].value
                    : 0;

                const percent = Math.min(100, Math.max(0, (currentStat / goal.targetValue) * 100));
                const isMet = currentStat >= goal.targetValue;

                return `
                    <div style="background: rgba(39, 39, 42, 0.4); border-radius: 12px; padding: 16px; position: relative; overflow: hidden;">
                        
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="font-size: 1.2em; background: ${et.color}20; padding: 6px; border-radius: 8px;">${et.icon}</div>
                                <div>
                                    <div style="font-weight: 600; color: #e4e4e7;">${et.name}</div>
                                    <div style="font-size: 0.8em; color: #a1a1aa; text-transform: capitalize;">${goal.period} goal</div>
                                </div>
                            </div>
                            <button onclick="deleteGoal('${goal.id}')" style="background: none; border: none; color: #ef4444; cursor: pointer; opacity: 0.8; padding: 4px; font-weight: bold; font-size: 1.2em; transition: opacity 0.2s;">‚úï</button>
                        </div>

                        <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 8px;">
                            <div style="font-size: 1.5em; font-weight: 700; color: ${isMet ? '#2ECC71' : '#e4e4e7'};">
                                ${parseFloat(currentStat.toFixed(1))}
                                <span style="font-size: 0.5em; color: #a1a1aa; font-weight: normal; margin-left: 2px;">/ ${goal.targetValue} ${et.primaryUnit || ''}</span>
                            </div>
                            <div style="font-size: 0.9em; font-weight: 600; color: ${isMet ? '#2ECC71' : '#a1a1aa'};">
                                ${Math.round(percent)}%
                            </div>
                        </div>

                        <!-- Progress Bar -->
                        <div style="height: 6px; background: rgba(255, 255, 255, 0.1); border-radius: 3px; overflow: hidden;">
                            <div style="height: 100%; width: ${percent}%; background: ${isMet ? '#2ECC71' : et.color}; border-radius: 3px; transition: width 0.5s ease;"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function deleteGoal(goalId) {
            if (!confirm('Remove this goal?')) return;
            const userId = localStorage.getItem('lifestats_userId');

            try {
                const response = await fetch(`/api/goals/${goalId}?userId=${userId}`, { method: 'DELETE' });
                if (response.ok) {
                    showNotification('Goal removed');
                    loadUserGoals(userId);
                }
            } catch (e) {
                console.error(e);
            }
        }
    </script>
    <!-- Fitness Goals Wizard -->
    <div id="fitnessWizardOverlay" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Fitness Plan Wizard</div>
                <button class="close-btn" onclick="closeFitnessWizard()">&times;</button>
            </div>

            <!-- Step 1: Inputs -->
            <div id="fwStep1">
                <p style="color: #a1a1aa; margin-bottom: 16px;">Let's calculate your personalized plan.</p>
                <div class="form-group">
                    <label>Target Weight (lbs)</label>
                    <input type="number" id="fwTargetWeight" placeholder="e.g. 170" required
                        style="padding: 12px; background: rgba(39, 39, 42, 0.6); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: #e4e4e7; width: 100%; box-sizing: border-box;">
                </div>
                <div class="form-group">
                    <label>Timeframe (weeks)</label>
                    <input type="number" id="fwWeeks" value="12" min="1" max="52" required
                        style="padding: 12px; background: rgba(39, 39, 42, 0.6); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: #e4e4e7; width: 100%; box-sizing: border-box;">
                </div>
                <div class="form-group">
                    <label>Activity Level</label>
                    <select id="fwActivity"
                        style="width: 100%; padding: 12px; background: rgba(39, 39, 42, 0.6); border: 1px solid #3f3f46; border-radius: 8px; color: #e4e4e7;">
                        <option value="1.2">Sedentary (Office job)</option>
                        <option value="1.375">Light Exercise (1-2 days/week)</option>
                        <option value="1.55">Moderate Exercise (3-5 days/week)</option>
                        <option value="1.725">Heavy Exercise (6-7 days/week)</option>
                    </select>
                </div>
                <button onclick="calculateFitnessPlan()" class="primary-btn" style="margin-top: 20px;">Calculate Plan
                    ‚Üí</button>
            </div>

            <!-- Step 2: Results -->
            <div id="fwStep2" class="hidden">
                <p style="color: #a1a1aa; margin-bottom: 16px;">Here is your recommended daily plan:</p>

                <div
                    style="background: rgba(46, 204, 113, 0.1); border: 1px solid rgba(46, 204, 113, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 16px; text-align: center;">
                    <div style="color: #a1a1aa; font-size: 0.9em;">Daily Calories</div>
                    <div style="font-size: 2em; font-weight: 700; color: #2ECC71;" id="fwResultCalories">-</div>
                    <div style="color: #a1a1aa; font-size: 0.8em; margin-top: 4px;" id="fwResultLossRate">-</div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 20px;">
                    <div
                        style="background: rgba(39, 39, 42, 0.6); padding: 8px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.8em; color: #a1a1aa;">Protein</div>
                        <div style="font-weight: 600;" id="fwResultProtein">-</div>
                    </div>
                    <div
                        style="background: rgba(39, 39, 42, 0.6); padding: 8px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.8em; color: #a1a1aa;">Carbs</div>
                        <div style="font-weight: 600;" id="fwResultCarbs">-</div>
                    </div>
                    <div
                        style="background: rgba(39, 39, 42, 0.6); padding: 8px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.8em; color: #a1a1aa;">Fat</div>
                        <div style="font-weight: 600;" id="fwResultFat">-</div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn-secondary"
                        onclick="document.getElementById('fwStep1').classList.remove('hidden'); document.getElementById('fwStep2').classList.add('hidden');">‚Üê
                        Back</button>
                    <button class="primary-btn" onclick="saveFitnessPlan()">Save Goals</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Virtual Event Types for Macros (injected for Goals)
        const VIRTUAL_EVENT_TYPES = [
            { id: 'protein', name: 'Protein', icon: 'ü•©', color: '#E91E63', primaryUnit: 'g' },
            { id: 'carbs', name: 'Carbs', icon: 'üçû', color: '#FFC107', primaryUnit: 'g' },
            { id: 'fat', name: 'Fat', icon: 'ü•ë', color: '#795548', primaryUnit: 'g' }
        ];

        function openFitnessGoalsWizard() {
            document.getElementById('fitnessWizardOverlay').classList.remove('hidden');
            document.getElementById('fwStep1').classList.remove('hidden');
            document.getElementById('fwStep2').classList.add('hidden');

            // Pre-fill if current weight known
            const weightDiv = document.getElementById('profileDisplayWeight');
            if (weightDiv && weightDiv.innerText !== '-') {
                // Try to nudge target weight slightly lower as default? No, leave empty or current.
                // document.getElementById('fwTargetWeight').value = parseFloat(weightDiv.innerText);
            }
        }

        function closeFitnessWizard() {
            document.getElementById('fitnessWizardOverlay').classList.add('hidden');
        }

        async function calculateFitnessPlan() {
            // 1. Get User Profile Data
            const userId = localStorage.getItem('lifestats_userId');
            if (!userId) return;

            let profile = null;
            try {
                const res = await fetch(`/api/profile?userId=${userId}`);
                if (res.ok) profile = await res.json();
            } catch (e) { }

            // Helper to get element value
            const getVal = (id) => parseFloat(document.getElementById(id).value);

            // Inputs
            const targetWeight = getVal('fwTargetWeight');
            const weeks = getVal('fwWeeks');
            const activity = getVal('fwActivity');

            if (!targetWeight || !weeks) {
                alert("Please enter target weight and weeks.");
                return;
            }

            // Need current weight, height, age, sex
            // We can try to get from profile API or DOM
            let currentWeight = 180; // Default fallback
            let heightInches = 70;
            let age = 30;
            let sex = 'male';

            if (profile) {
                if (profile.height_inches) heightInches = profile.height_inches;
                if (profile.sex) sex = profile.sex;
                if (profile.birthdate) {
                    const dob = new Date(profile.birthdate);
                    const diff_ms = Date.now() - dob.getTime();
                    const age_dt = new Date(diff_ms);
                    age = Math.abs(age_dt.getUTCFullYear() - 1970);
                }
            }

            // Fetch latest weight if possible, or use stats?
            // Assuming profile API returned it or we parsed it. 
            // Actually profile API might not return latest weight from events.
            // Let's check 'profileDisplayWeight' or assume profile has it?
            // The profile object we fetched usually doesn't update with daily logs unless we sync it.
            // Let's assume standard values for now or fetch /api/profile/weight
            try {
                const wRes = await fetch(`/api/profile/weight?userId=${userId}`);
                if (wRes.ok) {
                    const wData = await wRes.json();
                    if (wData && wData.weight) currentWeight = wData.weight;
                }
            } catch (e) { }

            // Mifflin-St Jeor
            // Weight in kg, Height in cm
            const weightKg = currentWeight * 0.453592;
            const heightCm = heightInches * 2.54;

            let bmr = (10 * weightKg) + (6.25 * heightCm) - (5 * age) + 5;
            if (sex === 'female') {
                bmr = (10 * weightKg) + (6.25 * heightCm) - (5 * age) - 161;
            }

            const tdee = bmr * activity;

            // Calculate Deficit
            // 1 lb fat = 3500 kcal
            const weightDiff = currentWeight - targetWeight;
            const totalDeficit = weightDiff * 3500;
            const dailyDeficit = totalDeficit / (weeks * 7);

            // Daily Goal
            let dailyCalories = Math.round(tdee - dailyDeficit);

            // Safety Check (don't go too low)
            if (dailyCalories < 1200 && sex === 'female') dailyCalories = 1200;
            if (dailyCalories < 1500 && sex === 'male') dailyCalories = 1500;

            // Macros (Standard 40/30/30 split or similar?)
            // Protein 1g per lb of target weight (usually good for retaining muscle)
            // Or 30% Protein, 35% Carbs, 35% Fat
            const proteinG = Math.round(targetWeight * 0.8); // 0.8 - 1g per lb
            const fatG = Math.round((dailyCalories * 0.25) / 9); // 25% fat
            const carbG = Math.round((dailyCalories - (proteinG * 4) - (fatG * 9)) / 4); // Remainder carbs

            // Display Results
            document.getElementById('fwResultCalories').innerText = dailyCalories;
            document.getElementById('fwResultLossRate').innerText = `${weeks} weeks`;
            document.getElementById('fwResultProtein').innerText = `${proteinG}g`;
            document.getElementById('fwResultCarbs').innerText = `${carbG}g`;
            document.getElementById('fwResultFat').innerText = `${fatG}g`;

            // Setup Globals for Save
            window.fitnessPlanData = {
                targetWeight,
                dailyCalories,
                proteinG,
                carbG,
                fatG
            };

            document.getElementById('fwStep1').classList.add('hidden');
            document.getElementById('fwStep2').classList.remove('hidden');
        }

        async function saveFitnessPlan() {
            if (!window.fitnessPlanData) return;
            const userId = localStorage.getItem('lifestats_userId');
            const data = window.fitnessPlanData;

            try {
                // 1. Weight Goal
                await fetch('/api/goals', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, eventTypeId: 'weight', targetValue: data.targetWeight, period: 'daily' }) // Weight is usually a 'target' not daily sum, but our goal system assumes targetValue. Render logic handles percent... wait. 
                    // Weight goal logic in Render: (currentStat / targetValue). If target is lower (loss), this percent logic is wrong.
                    // But for now let's save it. Logic refinement later.
                });

                // 2. Calorie Goal (Meal)
                await fetch('/api/goals', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, eventTypeId: 'meal', targetValue: data.dailyCalories, period: 'daily' })
                });

                // 3. Macros (Virtual Types)
                // We need to support them in backend Goals? Yes we confirmed no FK check.
                await fetch('/api/goals', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, eventTypeId: 'protein', targetValue: data.proteinG, period: 'daily' })
                });
                await fetch('/api/goals', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, eventTypeId: 'carbs', targetValue: data.carbG, period: 'daily' })
                });
                await fetch('/api/goals', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, eventTypeId: 'fat', targetValue: data.fatG, period: 'daily' })
                });

                showNotification('Fitness Plan Saved!');
                closeFitnessWizard();
                loadUserGoals(userId);

            } catch (e) {
                console.error(e);
                alert('Error saving plan');
            }
        }

    </script>
</body>

</html>
```